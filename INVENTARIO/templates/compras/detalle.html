{% extends "base.html" %}
{% block title %}Compra #{{ compra.id }}{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h5 mb-0">Compra #{{ compra.id }}</h1>
  <div class="btn-group">
    <a href="{% url 'compras-editar' compra.id %}" class="btn btn-light btn-sm"><i class="bi bi-pencil"></i></a>
    {% if compra.estado != 'Pagado' %}
      <a href="{% url 'compras-marcar-pagado' compra.id %}" class="btn btn-success btn-sm">
        <i class="bi bi-check2-circle me-1"></i> Marcar Pagado
      </a>
    {% endif %}
    <a href="{% url 'dev-compra-crear' compra.id %}" class="btn btn-warning btn-sm">
      <i class="bi bi-arrow-return-left me-1"></i> Nueva Devolución
    </a>
    {% if compra.estado != 'Devuelto' %}
      <a href="{% url 'compras-marcar-devuelto' compra.id %}" class="btn btn-outline-warning btn-sm">
        <i class="bi bi-bag-x me-1"></i> Marcar Devuelto
      </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body">
        <p class="mb-1"><strong>Proveedor:</strong> {{ compra.proveedor.nombre }}</p>
        <p class="mb-1"><strong># Doc:</strong> {{ compra.numero_documento|default:"—" }}</p>
        <p class="mb-1"><strong>Fecha:</strong> {{ compra.fecha|date:"d/m/Y H:i" }}</p>
        <p class="mb-0"><strong>Estado:</strong> {{ compra.get_estado_display }}</p>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Producto</th><th class="text-end">Cant.</th><th class="text-end">P.Unit</th><th class="text-end">Subt.</th><th class="text-end">IVA</th></tr></thead>
            <tbody>
              {% for d in compra.detalles.all %}
              <tr>
                <td>{{ d.producto.codigo }} — {{ d.producto.descripcion }}</td>
                <td class="text-end">{{ d.cantidad }}</td>
                <td class="text-end">{{ d.precio_unitario }}</td>
                <td class="text-end">{{ d.subtotal }}</td>
                <td class="text-end">{{ d.iva_item }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr><th colspan="3"></th><th class="text-end">{{ tot_sub }}</th><th class="text-end">{{ tot_iva }}</th></tr>
              <tr><th colspan="3"></th><th colspan="2" class="text-end h6 mb-0">Total: {{ tot_total }}</th></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
