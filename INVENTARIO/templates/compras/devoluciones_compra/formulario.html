{% extends "base.html" %}
{% block title %}Devolución — Compra #{{ compra.id }}{% endblock %}
{% block content %}

<h1 class="h6 mb-3">Nueva devolución — Compra #{{ compra.id }} ({{ compra.proveedor.nombre }})</h1>

<form method="post" novalidate>
  {% csrf_token %}

  <div class="card mb-3">
    <div class="card-body row g-3">
      <div class="col-12">
        <label class="form-label">Motivo</label>
        <textarea name="motivo" class="form-control" rows="2"></textarea>
      </div>
      <div class="col-md-4">
        <label class="form-label">Estado</label>
        <select name="estado" class="form-select">
          <option value="Aprobada">Aprobada</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Rechazada">Rechazada</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Detalles a devolver</span>
      <button class="btn btn-sm btn-light" type="button" id="add-row"><i class="bi bi-plus-lg"></i> Agregar línea</button>
    </div>
    <div class="card-body">
      <div id="rows">
        <div class="row g-2 mb-2 row-item">
          <div class="col-md-6">
            <label class="form-label">Producto</label>
            <select name="producto" class="form-select">
              <option value="">-- seleccione --</option>
              {% for p in productos %}
                <option value="{{ p.id }}">{{ p.codigo }} — {{ p.descripcion }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Cantidad</label>
            <input type="number" name="cantidad" min="1" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">Motivo detalle</label>
            <input type="text" name="motivo_detalle" class="form-control">
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-3 d-flex gap-2">
    <a href="{% url 'compras-detalle' compra.id %}" class="btn btn-light">Cancelar</a>
    <button class="btn btn-warning">Guardar devolución</button>
  </div>
</form>

<script>
  document.getElementById('add-row').addEventListener('click', function(){
    const rows = document.getElementById('rows');
    const item = rows.querySelector('.row-item').cloneNode(true);
    item.querySelectorAll('input').forEach(i => i.value = '');
    item.querySelector('select[name="producto"]').selectedIndex = 0;
    rows.appendChild(item);
  });
</script>
{% endblock %}
