{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta id="vp" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- Ajuste opcional del viewport en Android WebView en landscape -->
    <script>
      ;(function () {
        const ua = navigator.userAgent || ''
        // Detecta específicamente WebView de Android (evita afectar a Chrome normal)
        const isAndroidWV = /\bwv\b/i.test(ua)
        const isLandscape = () => (screen.orientation?.type || '').includes('landscape') || window.innerWidth > window.innerHeight
      
        function apply() {
          const meta = document.getElementById('vp')
          if (!meta) return
          if (isAndroidWV && isLandscape()) {
            // Si prefieres mantener breakpoints en lg, sube a 1280. Con md, no es estrictamente necesario.
            meta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover')
          } else {
            meta.setAttribute('content', 'width=device-width, initial-scale=1, viewport-fit=cover')
          }
        }
        apply()
        window.addEventListener('orientationchange', () => setTimeout(apply, 200))
        window.addEventListener('resize', () => setTimeout(apply, 200))
      })()
    </script>

    <title>
      {% block title %}
        INTRACOE
      {% endblock %}
    </title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="{% static 'utilities/css/style_base.css' %}" />

    <head>
      {% block extra_css %}
        <style>
          .navbar-brand-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
          }
          
          .navbar .container-fluid {
            position: relative; /* referencia para el centrado absoluto */
          }
          
          .ancho-completo {
            width: 100% !important;
          }
          
          .menu-show {
            display: block;
          }
          
          .menu-hidden {
            display: none;
          }
          
          .list-group-item-action.bg-menu-item:hover,
          .list-group-item-action.bg-menu-item:focus {
            background-color: #e2e9f4 !important;
            color: black !important;
          }
          
          /* ==== ESTILOS PARA MENÚ MÓVIL (offcanvas) ==== */
          .offcanvas-start {
            max-width: 280px;
          }
          
          .offcanvas-header {
            border-bottom: 1px solid #e1e5f2;
          }
          
          .offcanvas-body {
            display: flex;
            flex-direction: column;
            padding: 0;
          }
          
          .offcanvas-main {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
          }
          
          .offcanvas-footer {
            border-top: 1px solid #e1e5f2;
            padding: 0.75rem;
          }
          
          /* Estilos para menu lateral version movil */
          .offcanvas-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 0.75rem;
            padding: 0rem;
            font-size: 0.95rem;
            text-decoration: none;
            margin-bottom: 0.75rem;
            font-weight: 500;
          }
          
          .offcanvas-link i {
            font-size: 1rem;
          }
          
          /* Acordeón mobile */
          .offcanvas-accordion .accordion-item {
            border: 0;
            background: transparent;
          }
          
          .offcanvas-accordion .accordion-button {
            background: transparent;
            padding: 0.35rem 0;
            font-size: 0.95rem;
            font-weight: 500;
            color: #111827;
          }
          
          .offcanvas-accordion .accordion-button::after {
            transform: scale(0.8);
          }
          
          .offcanvas-accordion .accordion-collapse {
            margin-bottom: 0.25rem;
          }
          
          .offcanvas-accordion .list-group-item {
            border: 0;
            border-radius: 0.5rem;
            margin: 0.1rem 0.25rem;
            padding: 0.35rem 0.75rem;
            font-size: 0.9rem;
            background: #ffffff;
            color: #374151;
          }
          
          .offcanvas-accordion .list-group-item:hover {
            background: #e5edff;
            color: #111827;
          }
          
          /* ==== ESTILOS ESCRITORIO (sidebar izquierdo) ==== */
          @media (min-width: 768px) {
            :root {
              --navbar-height: 56px;
              --sidebar-bg: #f5f7fb;
              --sidebar-border: #e1e5f2;
            }
          
            .sidebar-menu {
              background: var(--sidebar-bg);
              border-right: 1px solid var(--sidebar-border);
            }
          
            .sidebar-inner {
              height: calc(100vh - var(--navbar-height));
              display: flex;
              flex-direction: column;
              padding: 0.75rem;
              gap: 0.75rem;
            }
          
            .sidebar-main {
              flex: 1;
              overflow-y: auto;
              padding-right: 0.25rem;
            }
          
            .sidebar-footer {
              border-top: 1px solid var(--sidebar-border);
              padding-top: 0.75rem;
            }
          
            .sidebar-link {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              background-color: #ffffff !important;
              color: #1f2933 !important;
              border-radius: 0.75rem;
              border: 1px solid #dde3f0;
              padding: 0.5rem 0.75rem;
              font-size: 0.95rem;
              text-decoration: none;
            }
          
            .sidebar-link i {
              font-size: 1rem;
            }
          
            .sidebar-link:hover {
              background-color: #0d47a1 !important;
              color: #ffffff !important;
              border-color: #0d47a1;
            }
          
            .sidebar-menu .accordion-item {
              border: 0;
              background: transparent;
              margin-bottom: 0.25rem;
              border-radius: 0.75rem;
              overflow: hidden;
            }
          
            .sidebar-menu .accordion-button {
              background: transparent;
              padding: 0.4rem 0.75rem;
              font-size: 0.95rem;
              font-weight: 500;
              color: #111827;
            }
          
            .sidebar-menu .accordion-button::after {
              transform: scale(0.8);
            }
          
            .sidebar-menu .accordion-button:not(.collapsed) {
              background-color: #0d47a1;
              color: #ffffff;
            }
          
            .sidebar-menu .accordion-button:not(.collapsed)::after {
              filter: invert(100);
              color: black;
            }
          
            .sidebar-submenu .list-group-item {
              border: 0;
              border-radius: 0.5rem;
              margin: 0.15rem 0.4rem;
              padding: 0.35rem 0.75rem;
              font-size: 0.9rem;
              background: #ffffff;
              color: #374151;
            }
          
            .sidebar-submenu .list-group-item:hover {
              background: #e5edff;
              color: #111827;
            }
          
            /* Ocultar offcanvas en desktop */
            .offcanvas-start {
              display: none !important;
            }
          }
        </style>
      {% endblock %}
    </head>
  </head>

  <body class="bg-light">
    <!-- TOPBAR -->
    <nav class="navbar navbar-dark bg-primary sticky-top">
      <div class="container-fluid">
        <div class="d-flex gap-4">
          <!-- Botón menú móvil -->
          <button class="btn btn-outline-light d-md-none me-2" data-bs-toggle="offcanvas" data-bs-target="#sidebarOff" id="menu-mobil"><i class="bi bi-list"></i></button>

          <!-- Botón ir atrás -->
          {% if user.is_authenticated %}
            <button class="btn btn-outline-light me-2" onclick="window.history.back()"><i class="bi bi-arrow-left"></i></button>
          {% endif %}
        </div>
        <!-- Nombre/logo -->
        <a class="navbar-brand fw-bold navbar-brand-center" href="{% url 'index' %}">Intra<span class="text-accent">coe</span></a>

        <div class="d-flex align-items-center gap-2">
          {% if user.is_authenticated %}
            <div class="d-flex">
              <button class="btn btn-link text-white"><i class="bi bi-bell"></i></button>
              <button class="btn btn-outline-light" data-bs-toggle="offcanvas" data-bs-target="#profileOff">
                <i class="bi bi-person-circle me-1"></i>
                {{ user.username }}
              </button>
            </div>
          {% else %}
            <a href="{% url 'login' %}" class="btn btn-primary w-100 mb-2"><i class="bi bi-box-arrow-in-right me-2"></i> Iniciar sesión</a>
          {% endif %}
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <!-- SIDEBAR DESKTOP (visible desde md) -->
        {% if user.is_authenticated %}
          <aside class="col-md-3 col-xl-2 d-none d-md-block p-0 border-end bg-white sidebar sidebar-menu sticky">
            <div class="sidebar-sticky p-3 d-flex flex-column justify-content-between">
              <!-- link directo -->
              <div>
                {% if user.role == 'admin' or user.role == 'supervisor' %}
                  <a href="{% url 'index' %}" class="list-group-item list-group-item-action border-0 m-0 rounded-0 d-flex align-items-center gap-2 bg-menu-item">
                    <i class="bi bi-speedometer2"></i>
                    <span class="fw-medium">Dashboard</span>
                  </a>
                {% endif %}

                <!-- acordeón -->
                <div class="accordion accordion-flush sidebar" id="accMenu">
                  <!-- Compras -->
                  {% if user.role == 'admin' or user.role == 'supervisor' %}
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sbCompras"><i class="bi bi-basket me-2"></i> Compras</button></h2>
                      <div id="sbCompras" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu/compras.html' with uid='desk' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}

                  <!-- Ventas -->
                  {% if user.role == 'admin' or user.role == 'supervisor' %}
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sbVentas"><i class="bi bi-receipt-cutoff me-2"></i> Ventas</button></h2>
                      <div id="sbVentas" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu/ventas.html' with uid='deskV' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}


                  <!-- Facturación -->
                  {% if user.role == 'admin' or user.role == 'supervisor' %}
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sbFact"><i class="bi bi-file-earmark-text me-2"></i> Facturación</button></h2>
                      <div id="sbFact" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu/facturacion.html' with uid='deskF' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}

                  <!-- Inventario -->
                  {% if user.role == 'admin' or user.role == 'supervisor' %}
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sbInv"><i class="bi bi-box-seam me-2"></i> Inventario</button></h2>
                      <div id="sbInv" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu/inventario.html' with uid='deskI' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}

                </div>

                <hr class="my-3 border border-bottom border-dark-subtle" />

                {% if emisor.es_restaurante and user.is_authenticated %}
                  {% if user.role == 'admin' or user.role == 'supervisor' %}
                    <h6>Restarurante</h6>
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#Cocina"><i class="bi bi-basket me-2"></i> Cocina</button></h2>
                      <div id="Cocina" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu_restaurante/cocina.html' with uid='cocina' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}

                  {% if user.role == 'admin' or user.role == 'supervisor' %}
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ConfiguracionRestaurante"><i class="bi bi-basket me-2"></i> Configuración restaurante</button></h2>
                      <div id="ConfiguracionRestaurante" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu_restaurante/configuracion_restaurante.html' with uid='ped' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}

                  {% if user.role == 'admin' or user.role == 'supervisor' or user.role == 'mesero' %}
                    <div class="accordion-item">
                      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#meseros"><i class="bi bi-basket me-2"></i>Meseros</button></h2>
                      <div id="meseros" class="accordion-collapse collapse" data-bs-parent="#accMenu">
                        <div class="list-group list-group-flush">
                          {% include 'opciones_menu_restaurante/meseros.html' with uid='mes' %}
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endif %}
              </div>

              <hr class="my-3" />

              {% if user.is_staff %}
                <div class="list-group list-group-flush">
                  <a class="list-group-item list-group-item-action d-none"><i class="bi bi-calculator me-2"></i> Contabilidad</a>
                  <hr class="my-3" />
                  <a class="list-group-item list-group-item-action d-none"><i class="bi bi-buildings me-2"></i> Empresa</a>
                  <hr class="my-3" />
                  <a class="list-group-item list-group-item-action border-0 bg-white" href="{% url 'configurar_empresa' %}"><i class="bi bi-gear me-2"></i> Configurar empresa</a>
                </div>
              {% endif %}
            </div>
          </aside>
        {% endif %}

        <!-- SIDEBAR MÓVIL (OFFCANVAS) -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOff">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menú</h5>
            <button class="btn-close" data-bs-dismiss="offcanvas"></button>
          </div>

          {% if user.is_authenticated %}
            <div class="offcanvas-body">
              <div class="offcanvas-main pt-4">
                <!-- Dashboard como tarjeta -->
                <a href="{% url 'index' %}" class="offcanvas-link"><span>Dashboard</span></a>

                <!-- Acordeón principal -->
                <div class="accordion accordion-flush offcanvas-accordion d-flex flex-column gap-2" id="accMenuMobile">
                  <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#mCompras">Compras</button></h2>
                    <div id="mCompras" class="accordion-collapse collapse" data-bs-parent="#accMenuMobile">
                      <div class="list-group list-group-flush">
                        {% include 'opciones_menu/compras.html' with uid='mob' %}
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#mVentas">Ventas</button></h2>
                    <div id="mVentas" class="accordion-collapse collapse" data-bs-parent="#accMenuMobile">
                      <div class="list-group list-group-flush">
                        {% include 'opciones_menu/ventas.html' with uid='mobV' %}
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#mFact">Facturación</button></h2>
                    <div id="mFact" class="accordion-collapse collapse" data-bs-parent="#accMenuMobile">
                      <div class="list-group list-group-flush">
                        {% include 'opciones_menu/facturacion.html' with uid='mobF' %}
                      </div>
                    </div>
                  </div>

                  <div class="accordion-item">
                    <h2 class="accordion-header"><button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#mInv">Inventario</button></h2>
                    <div id="mInv" class="accordion-collapse collapse" data-bs-parent="#accMenuMobile">
                      <div class="list-group list-group-flush">
                        {% include 'opciones_menu/inventario.html' with uid='mobI' %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {% if user.is_staff %}
                <div class="offcanvas-footer">
                  <a class="offcanvas-link" href="{% url 'configurar_empresa' %}">
                    <i class="bi bi-gear me-2"></i>
                    Configurar empresa
                  </a>
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="p-3">
              <p class="text-muted small mb-1">Por favor, inicia sesión para ver el menú.</p>
            </div>
          {% endif %}
        </div>

        <!-- CONTENIDO -->

        <main class="col-md-9 col-xl-10 p-3" id="main-content">
          <div class="card shadow-sm">
            <div class="card-body">
              {% block content %}
                {% if user.is_authenticated %}
                  {% include 'index.html' %}
                {% else %}
                  <p>Not Login.</p>
                {% endif %}
              {% endblock %}
            </div>
          </div>

          <p class="small text-muted mt-3">
            Copyright ©<script>
                         document.write(new Date().getFullYear())
                       </script>| Desarrollado por <a class="text-decoration-none">Ing. Francisco Antonio Flores Villalta</a>.
          </p>
        </main>
      </div>
    </div>

    <!-- PERFIL (offcanvas derecha) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="profileOff" aria-labelledby="profileOffLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="profileOffLabel">Perfil</h5>
        <button class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
      </div>

      <div class="offcanvas-body mx-4 my-2">
        {% if user.is_authenticated %}
          <p class="mb-1 fw-semibold">{{ user.get_full_name|default:user.perfilusuario.nombre }}</p>
          <p class="text-muted small mb-3">{{ user.email }}</p>

          <a href="{% url 'perfil_usuario' %}" class="btn btn-primary w-100 mb-2"><i class="bi bi-person me-2"></i> Ver perfil</a>

          <p class="small text-muted mb-3">Miembro desde: {{ user.date_joined|date:'d M, Y' }}</p>
          <hr class="my-2" />

          <form action="{% url 'logout' %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-box-arrow-right me-2"></i> Cerrar sesión</button>
          </form>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-primary w-100 mb-2"><i class="bi bi-box-arrow-in-right me-2"></i> Iniciar sesión</a>
        {% endif %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>      
      document.addEventListener('DOMContentLoaded', () => {
          const menu = document.querySelector('.sidebar-menu')
          const mainContent = document.getElementById("main-content")
          const menuButton = document.getElementById("menu-mobil")

          
          {% if user.is_authenticated %}
            console.log('SI, el usuario está autenticado.')

          if (mainContent) {
            mainContent.classList.remove('ancho-completo')
          }
          if (menu) {
            menu.classList.add('menu-show')
            menu.classList.remove('menu-hidden')
          }
          if (menuButton) {
            menuButton.classList.remove('d-none')
          }
        {% else %}
          console.log('NO, el usuario no está autenticado.')

          if (mainContent) {
            mainContent.classList.add('ancho-completo')
          }
          if (menu) {
            menu.classList.add('menu-hidden')
            menu.classList.remove('menu-show')
          }
          if (menuButton) {
            menuButton.classList.add('d-none')
          }
        {% endif %}
      })
</script>
  </body>
</html>
