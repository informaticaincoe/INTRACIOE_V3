{% extends "base.html" %}
{% load static %}

{% block title %}Iniciar sesión · INTRACOE{% endblock %}

{% block content %}
<div class="container min-vh-100 d-flex align-items-center justify-content-center py-5">
  <div class="card shadow border-0 rounded-4 w-100" style="max-width: 450px;">
    <div class="card-body p-4 p-md-5">
      <div class="text-center mb-4">
        <i class="bi bi-shield-lock" style="font-size:2rem;"></i>
        <h1 class="h4 mt-2 mb-0">Iniciar sesión</h1>
        <p class="text-muted small mb-0">Ingresa tus credenciales para continuar</p>
      </div>

      {# Mensajes generales (Django messages) #}
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags|default:'info' }} mb-3" role="alert">{{ message }}</div>
        {% endfor %}
      {% endif %}

      {# Errores de autenticación personalizados #}
      {% if error_message %}
        <div class="alert alert-danger mb-3" role="alert">{{ error_message }}</div>
      {% endif %}

      {# Errores del AuthenticationForm si lo usas como 'form' #}
      {% if form and form.non_field_errors %}
        <div class="alert alert-danger mb-3" role="alert">
          {% for err in form.non_field_errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      <form action="" method="post" class="needs-validation" novalidate>
        {% csrf_token %}
        {% if next %}<input type="hidden" name="next" value="{{ next }}">{% endif %}

        <div class="mb-3">
          <label for="id_username" class="form-label">Usuario</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-person"></i></span>
            <input
              type="text"
              class="form-control"
              id="id_username"
              name="username"
              placeholder="tu.usuario"
              autocomplete="username"
              required
              autofocus>
            <div class="invalid-feedback">Ingresa tu usuario.</div>
          </div>
          {% if form and form.username.errors %}
            <div class="text-danger small mt-1">
              {% for err in form.username.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="mb-2">
          <label for="id_password" class="form-label">Contraseña</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input
              type="password"
              class="form-control"
              id="id_password"
              name="password"
              placeholder="••••••••"
              autocomplete="current-password"
              required>
            <button class="btn btn-outline-secondary" type="button" id="togglePassword" aria-label="Mostrar u ocultar contraseña">
              <i class="bi bi-eye" id="toggleIcon"></i>
            </button>
            <div class="invalid-feedback">Ingresa tu contraseña.</div>
          </div>
          <div id="capsWarning" class="form-text text-danger d-none mt-1">
            Bloq Mayús activado.
          </div>
          {% if form and form.password.errors %}
            <div class="text-danger small mt-1">
              {% for err in form.password.errors %}{{ err }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="on" id="remember" name="remember">
            <label class="form-check-label" for="remember">Recordarme</label>
          </div>
        </div>

        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-box-arrow-in-right me-1"></i> Ingresar
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Bootstrap validation
  (function () {
    const form = document.querySelector('form.needs-validation');
    if (form) {
      form.addEventListener('submit', function (e) {
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
        } else {
          // Evita doble envío
          const btn = form.querySelector('button[type="submit"]');
          if (btn) { btn.disabled = true; }
        }
        form.classList.add('was-validated');
      }, false);
    }
  })();

  // Toggle de contraseña
  (function () {
    const input = document.getElementById('id_password');
    const btn = document.getElementById('togglePassword');
    const icon = document.getElementById('toggleIcon');
    if (btn && input && icon) {
      btn.addEventListener('click', function () {
        const isPwd = input.getAttribute('type') === 'password';
        input.setAttribute('type', isPwd ? 'text' : 'password');
        icon.classList.toggle('bi-eye');
        icon.classList.toggle('bi-eye-slash');
      });
    }
  })();

  // Advertencia de Bloq Mayús
  (function () {
    const pwd = document.getElementById('id_password');
    const warn = document.getElementById('capsWarning');
    if (pwd && warn) {
      pwd.addEventListener('keyup', (e) => {
        const caps = e.getModifierState && e.getModifierState('CapsLock');
        warn.classList.toggle('d-none', !caps);
      });
    }
  })();
</script>
{% endblock content %}
