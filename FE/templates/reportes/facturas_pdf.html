<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Facturas</title>
  <!-- Bootstrap para estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-size: 12px; }
    h2 { margin-bottom: 20px; }
    table { font-size: 12px; }
    .table thead th { background-color: #f8f9fa; }
    .totales { margin-top: 25px; }
    .detalles { margin-top: 10px; font-size: 11px; color: #555; }
    .subtabla { margin: 10px 0 20px 40px; }
    .subtabla th { background: #f1f1f1; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center">Reporte de Facturas</h2>

    <!-- Tabla principal -->
    <table class="table table-bordered table-striped table-sm">
      <thead class="table-dark text-center">
        <tr>
          <th>Número de Control</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Fecha</th>
          <th class="text-end">Total</th>
          <th class="text-end">IVA</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for f in facturas %}
        <tr>
          <td>{{ f.numero_control }}</td>
          <td>{{ f.dtereceptor.nombre }}</td>
          <td>{{ f.tipo_dte.descripcion }}</td>
          <td>{{ f.fecha_emision|date:"d/m/Y" }}</td>
          <td class="text-end">${{ f.total_pagar|default:"0.00" }}</td>
          <td class="text-end">${{ f.total_iva|default:"0.00" }}</td>
          <td>
            {% if f.dte_invalidacion.exists %}
              <span class="badge bg-danger">Anulada</span>
            {% else %}
              <span class="badge bg-success">Viva</span>
            {% endif %}
          </td>
        </tr>

        <!-- Subtabla de productos -->
        <tr>
          <td colspan="7">
            <table class="table table-sm table-bordered subtabla">
              <thead>
                <tr class="table-light">
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for det in f.detalles.all %}
                <tr>
                  <td>{{ det.producto.descripcion }}</td>
                  <td>{{ det.cantidad }}</td>
                  <td>${{ det.precio_unitario|default:"0.00" }}</td>
                  <td class="text-end">
                    ${{ det.subtotal|default:det.precio_unitario|default:"0.00" }}
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">Sin productos</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="7" class="text-center text-muted">No se encontraron facturas</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Totales -->
    <div class="totales">
      <h5>Totales</h5>
      <table class="table table-bordered table-sm w-50">
        <tr>
          <th>Cantidad de Facturas</th>
          <td>{{ total_facturas }}</td>
        </tr>
        <tr>
          <th>Total Facturado</th>
          <td>${{ total_monto|floatformat:2 }}</td>
        </tr>
        <tr>
          <th>Total IVA</th>
          <td>${{ total_iva|floatformat:2 }}</td>
        </tr>
        <tr class="table-secondary">
          <th>Total Líneas de Productos</th>
          <td>{{ total_lineas }}</td>
        </tr>
        <tr class="table-secondary">
          <th>Total Cantidad Vendida</th>
          <td>{{ total_cantidad }}</td>
        </tr>
      </table>
    </div>

    <!-- Detalles de filtros -->
    <div class="detalles">
      <p><strong>Filtros aplicados:</strong></p>
      <ul>
        <li>Recibido MH: {{ request.GET.recibido_mh|default:"Todos" }}</li>
        <li>Tipo DTE: {% if request.GET.tipo_dte %}{{ request.GET.tipo_dte }}{% else %}Todos{% endif %}</li>
        <li>Fecha: 
          {% if request.GET.fecha_ini or request.GET.fecha_fin %}
            {{ request.GET.fecha_ini|default:"-" }} a {{ request.GET.fecha_fin|default:"-" }}
          {% else %}
            Todas
          {% endif %}
        </li>
      </ul>
    </div>
  </div>
</body>
</html>
