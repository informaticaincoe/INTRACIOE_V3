{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h4 class="mb-3">{% if c %}Editar cliente{% else %}Nuevo cliente{% endif %}</h4>

  <form method="post" class="row g-3 mt-2" autocomplete="off">
    {% csrf_token %}

    <!-- Tipo de persona -->
    <div class="col-md-3">
      <label class="form-label">Tipo de persona</label>
      <select name="tipo_persona" id="tipo_persona" class="form-select" required>
        <option value="">Seleccione…</option>
        {% for tp in tipos_persona %}
          <option value="{{ tp.id }}"
                  data-codigo="{{ tp.codigo|default_if_none:'' }}"
                  {% if c and c.tipo_persona_id == tp.id %}selected{% endif %}>
            {{ tp.descripcion }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Tipo documento (visible solo para jurídica; natural usa DUI por defecto) -->
    <div class="col-md-3" data-juridica id="wrap_tipo_doc">
      <label class="form-label">Tipo documento</label>
      <select name="tipo_documento" id="tipo_documento" class="form-select">
        <option value="">Seleccione…</option>
        {% for t in tipos_doc %}
          <option value="{{ t.id }}"
                  data-codigo="{{ t.codigo|default_if_none:'' }}"
                  {% if c and c.tipo_documento_id == t.id %}selected{% endif %}>
            {{ t.descripcion }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text" id="help_tipo_doc" style="display:none;">Para persona natural se usa DUI automáticamente.</div>
    </div>

    <!-- N° documento (DUI u otro) -->
    <div class="col-md-3" data-natural data-juridica>
      <label class="form-label">N° documento</label>
      <input name="num_documento" id="num_documento" class="form-control"
             value="{{ c.num_documento|default_if_none:'' }}" placeholder="########-#">
      <div class="form-text" id="help_dui">Natural: DUI con formato 12345678-9</div>
    </div>

    <!-- NRC (solo jurídica) -->
    <div class="col-md-3" data-juridica>
      <label class="form-label">NRC</label>
      <input name="nrc" id="nrc" class="form-control" value="{{ c.nrc|default_if_none:'' }}">
    </div>

    <!-- Nombre -->
    <div class="col-md-6" data-natural data-juridica>
      <label class="form-label">Nombre</label>
      <input name="nombre" id="nombre" class="form-control" value="{{ c.nombre|default_if_none:'' }}">
    </div>

    <!-- Nombre comercial -->
    <div class="col-md-6" data-natural data-juridica>
      <label class="form-label">Nombre comercial</label>
      <input name="nombreComercial" id="nombreComercial" class="form-control"
             value="{% if c and c.nombreComercial %}{{ c.nombreComercial }}{% elif c and c.nombre %}{{ c.nombre }}{% else %}{% endif %}">
    </div>

    <!-- Dirección -->
    <div class="col-md-6" data-natural data-juridica>
      <label class="form-label">Dirección</label>
      <input name="direccion" id="direccion" class="form-control"
             value="{{ c.direccion|default_if_none:'' }}" placeholder="N/A si no aplica">
    </div>

    <!-- Municipio -->
    <div class="col-md-3" data-natural data-juridica>
      <label class="form-label">Municipio</label>
      <select name="municipio" id="municipio" class="form-select">
        <option value="">Seleccione…</option>
        {% for m in municipios %}
          <option value="{{ m.id }}" {% if c and c.municipio_id == m.id %}selected{% endif %}>
            {{ m.departamento.descripcion }} - {{ m.descripcion }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- País (solo jurídica) -->
    <div class="col-md-3" data-juridica>
      <label class="form-label">País</label>
      <select name="pais" id="pais" class="form-select">
        <option value="">Seleccione…</option>
        {% for p in paises %}
          <option value="{{ p.id }}" {% if c and c.pais_id == p.id %}selected{% endif %}>
            {{ p.descripcion }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Teléfono -->
    <div class="col-md-3" data-natural data-juridica>
      <label class="form-label">Teléfono</label>
      <input name="telefono" id="telefono" class="form-control" value="{{ c.telefono|default_if_none:'' }}">
    </div>

    <!-- Correo (solo jurídica visible; natural usará default si viene vacío) -->
    <div class="col-md-3" data-juridica>
      <label class="form-label">Correo</label>
      <input name="correo" id="correo" type="email" class="form-control"
             value="{{ c.correo|default_if_none:'' }}" placeholder="ventasdetalleincoe@gmail.com">
    </div>

    <!-- Actividades Económicas (jurídica) -->
    <div class="col-12" data-juridica>
      <label class="form-label">Actividades económicas</label>
      <select name="actividades_economicas" class="form-select" multiple size="6">
        {% for a in actividades %}
          <option value="{{ a.id }}"
            {% if c and a in c.actividades_economicas.all %}selected{% endif %}>
            {{ a.codigo }} — {{ a.descripcion }}
          </option>
        {% endfor %}
      </select>
    </div>

    {# === GEO: lat/lng + botón + mapa === #}
    <div class="col-md-6" data-natural data-juridica>
      <label class="form-label">Latitud</label>
      <input type="number" step="0.000001" inputmode="decimal" lang="en"
             class="form-control" name="lat" id="id_lat"
             value="{{ c.lat|default_if_none:'' }}">
    </div>

    <div class="col-md-6" data-natural data-juridica>
      <label class="form-label">Longitud</label>
      <input type="number" step="0.000001" inputmode="decimal" lang="en"
             class="form-control" name="lng" id="id_lng"
             value="{{ c.lng|default_if_none:'' }}">
    </div>

    <div class="col-12" data-natural data-juridica>
      <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-geo">
        Usar mi ubicación
      </button>
      <small class="text-muted ms-2">o haz clic en el mapa</small>

      <!-- Leaflet CSS/JS -->
      <link rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""/>
      <div id="map" style="height: 330px; border:1px solid #ccc; margin-top:8px;"></div>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
              integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
              crossorigin=""></script>
    </div>

    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary">Guardar</button>
      <a href="{% url 'clientes_list' %}" class="btn btn-light">Cancelar</a>
    </div>
  </form>
</div>

<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);
  const $$= (s,root=document)=>Array.from(root.querySelectorAll(s));

  const selTipoPersona = $('#tipo_persona');
  const selTipoDoc     = $('#tipo_documento');
  const numDoc         = $('#num_documento');

  function showGroup(selector, on){ $$(selector).forEach(el=>el.style.display = on ? '' : 'none'); }
  function setReq(id, on){ const el = document.getElementById(id); if(!el) return; on?el.setAttribute('required','required'):el.removeAttribute('required'); }
  function setReqMany(ids,on){ ids.forEach(id=>setReq(id,on)); }

  function getTipoPersonaCode(){
    const opt = selTipoPersona?.options[selTipoPersona.selectedIndex];
    const byData = (opt?.dataset?.codigo || '').trim();
    if (byData) return byData;                // si tu modelo expone 'codigo'
    const val = (opt?.value||'').trim();
    if (val === '1' || val === '2') return val; // fallback si tus IDs coinciden con código
    const txt = (opt?.text||'').toUpperCase();
    if (txt.includes('NAT')) return '1';
    if (txt.includes('JUR')) return '2';
    return '';
  }

  function forceDUI(){
    if (!selTipoDoc) return;
    // En tus logs: catálogo tiene "13 - DUI"
    const optDui = Array.from(selTipoDoc.options).find(o => {
      const cod = (o.dataset.codigo||'').trim();
      const txt = (o.text||'').toUpperCase();
      return cod === '13' || txt.includes('DUI');
    });
    if (optDui) selTipoDoc.value = optDui.value;

    if (numDoc){
      numDoc.setAttribute('pattern','[0-9]{8}-[0-9]');
      numDoc.setAttribute('title','Formato: ########-#');
      if (!numDoc.placeholder) numDoc.placeholder = '########-#';
    }
    const help = document.getElementById('help_tipo_doc');
    if (help) help.style.display = '';
  }

  function onTipoPersonaChange(){
    const code = getTipoPersonaCode();
    const isNat = (code==='1');
    const isJur = (code==='2');

    // mostrar/ocultar grupos
    showGroup('[data-juridica]', isJur);
    showGroup('[data-natural]',  true);  // campos comunes marcados para ambos

    if (isNat){
      // Requisitos Natural
      setReqMany(['num_documento','nombre','telefono'], true);
      setReqMany(['tipo_documento','nrc','correo','pais'], false);
      // Municipio y dirección suelen ser útiles para geocodificar, hazlos opcionales si no deseas forzarlos:
      // setReq('municipio', true); setReq('direccion', true);
      forceDUI();
    } else if (isJur){
      // Requisitos Jurídica
      setReqMany(['tipo_documento','num_documento','nombre','municipio'], true);
      setReqMany(['telefono'], false);
      if (numDoc){
        numDoc.removeAttribute('pattern');
        numDoc.removeAttribute('title');
      }
      const help = document.getElementById('help_tipo_doc');
      if (help) help.style.display = 'none';
    }
  }

  // Estado inicial: si viene vacío, intenta seleccionar "Natural"
  if (selTipoPersona && !selTipoPersona.value){
    const optNat = Array.from(selTipoPersona.options)
      .find(o => (o.dataset.codigo||'')==='1' || (o.text||'').toUpperCase().includes('NAT'));
    if (optNat) selTipoPersona.value = optNat.value;
  }

  selTipoPersona?.addEventListener('change', onTipoPersonaChange);
  onTipoPersonaChange();

  // ========= Mapa / Geolocalización =========
  (function initMap(){
    const $lat = document.getElementById('id_lat');
    const $lng = document.getElementById('id_lng');

    const initLat = parseFloat($lat?.value) || 13.69294;
    const initLng = parseFloat($lng?.value) || -89.21819;
    const zoom    = ($lat?.value && $lng?.value) ? 15 : 12;

    // Si no existe el contenedor (p.ej. layout distinto), salir sin error
    const mapEl = document.getElementById('map');
    if (!mapEl || !window.L) return;

    const map = L.map('map').setView([initLat, initLng], zoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    let marker = null;

    function setMarker(lat, lng) {
      if (!isFinite(lat) || !isFinite(lng)) return;
      if (marker) {
        marker.setLatLng([lat, lng]);
      } else {
        marker = L.marker([lat, lng], {draggable: true}).addTo(map);
        marker.on('dragend', function(){
          const ll = marker.getLatLng();
          if ($lat) $lat.value = ll.lat.toFixed(6);
          if ($lng) $lng.value = ll.lng.toFixed(6);
        });
      }
      if ($lat) $lat.value = (+lat).toFixed(6);
      if ($lng) $lng.value = (+lng).toFixed(6);
      map.setView([lat, lng], 15);
    }

    if ($lat?.value && $lng?.value) setMarker(initLat, initLng);

    map.on('click', function(e) {
      setMarker(e.latlng.lat, e.latlng.lng);
    });

    const btn = document.getElementById('btn-geo');
    btn?.addEventListener('click', function(){
      if (!navigator.geolocation) {
        return alert('Geolocalización no soportada.');
      }
      navigator.geolocation.getCurrentPosition(function(pos){
        setMarker(pos.coords.latitude, pos.coords.longitude);
      }, function(err){
        alert('No se pudo obtener tu ubicación (' + err.message + ').');
      }, {enableHighAccuracy:true, timeout:8000});
    });

    // Si el usuario escribe lat/lng manualmente, mueve el marker
    ['input','change'].forEach(evt => {
      $lat?.addEventListener(evt, ()=> {
        const lat = parseFloat($lat.value);
        const lng = parseFloat($lng.value);
        if (isFinite(lat) && isFinite(lng)) setMarker(lat, lng);
      });
      $lng?.addEventListener(evt, ()=> {
        const lat = parseFloat($lat.value);
        const lng = parseFloat($lng.value);
        if (isFinite(lat) && isFinite(lng)) setMarker(lat, lng);
      });
    });
  })();

})();
</script>
{% endblock %}
