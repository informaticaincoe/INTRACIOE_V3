<div class="modal fade" id="productosModal" tabindex="-1" aria-labelledby="productosLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="productosLabel" class="modal-title"><i class="bi bi-search me-2"></i> Catálogo de productos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-md-6">
            <input type="text" id="buscarProducto" class="form-control" placeholder="Buscar o escanear código…" autocomplete="off">
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="btnMenosCant">−</button>
              <input type="number" min="1" value="1" id="cantidadProducto" class="form-control text-center">
              <button class="btn btn-outline-secondary" type="button" id="btnMasCant">+</button>
            </div>
          </div>
          <div class="col-md-3">
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" step="0.01" min="0" id="precioProducto" class="form-control" placeholder="Precio (opcional)">
            </div>
          </div>
          <div class="col-12 d-flex align-items-center gap-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="aplicaIvaProducto" checked>
              <label class="form-check-label" for="aplicaIvaProducto">Aplica IVA</label>
            </div>
            <small class="text-muted">Enter agrega – Esc cierra</small>
          </div>
        </div>

        <!-- Grid listado -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-2" id="listaProductos">
          {# Tu JS poblará esta grilla (cards con data-product-id) #}
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="small text-muted">Sugerencia: usa <span class="kbd">Enter</span> para agregar el producto seleccionado.</div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnAddProducto"><i class="bi bi-plus-circle me-1"></i> Agregar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('productosModal');
  const grid  = document.getElementById('listaProductos');
  const inputBuscar = document.getElementById('buscarProducto');
  const btnAdd = document.getElementById('btnAddProducto');
  const cantInput = document.getElementById('cantidadProducto');
  const precioInput = document.getElementById('precioProducto');
  const chkIva = document.getElementById('aplicaIvaProducto');

  let state = {
    q: '',
    page: 1,
    hasNext: false,
    selected: null, // {id, codigo, nombre, precio, stock, con_iva}
    items: []
  };

  const apiUrl = "{% url 'api_productos' %}";

  function debounce(fn, ms){
    let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), ms); };
  }

  function cardTemplate(p){
    const price = Number(p.precio || 0).toFixed(2);
    return `
      <div class="col">
        <div class="card h-100 product-card ${state.selected && state.selected.id===p.id ? 'border-primary' : ''}"
             data-id="${p.id}"
             data-codigo="${p.codigo||''}"
             data-nombre="${p.nombre||''}"
             data-precio="${price}"
             data-stock="${p.stock||0}"
             data-coniva="${p.con_iva ? '1':'0'}"
             role="button"
        >
          ${p.imagen ? `<img src="${p.imagen}" class="card-img-top" alt="${p.nombre}">` : ''}
          <div class="card-body p-2">
            <div class="fw-semibold small mb-1" title="${p.nombre}">${p.nombre}</div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="badge text-bg-light">#${p.codigo||'-'}</span>
              <span class="fw-bold">$${price}</span>
            </div>
            <div class="small text-muted mt-1">Stock: ${p.stock ?? 0}</div>
          </div>
        </div>
      </div>
    `;
  }

  function render(append=false){
    if (!append) grid.innerHTML = '';
    if (!append && state.items.length === 0){
      grid.innerHTML = `<div class="col-12 text-center text-muted py-4">No se encontraron productos.</div>`;
      return;
    }
    const frag = document.createDocumentFragment();
    const temp = document.createElement('div');
    temp.innerHTML = state.items.map(cardTemplate).join('');
    while (temp.firstChild) frag.appendChild(temp.firstChild);
    grid.appendChild(frag);

    // botón "Cargar más"
    const existingMore = document.getElementById('btnLoadMoreProductos');
    if (existingMore) existingMore.remove();
    if (state.hasNext){
      const moreWrap = document.createElement('div');
      moreWrap.className = 'col-12 d-grid';
      moreWrap.innerHTML = `<button class="btn btn-outline-secondary" id="btnLoadMoreProductos">Cargar más</button>`;
      grid.appendChild(moreWrap);
      moreWrap.querySelector('button').addEventListener('click', () => {
        state.page += 1;
        load(true);
      });
    }

    // selección de card
    grid.querySelectorAll('.product-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        grid.querySelectorAll('.product-card').forEach(c=>c.classList.remove('border-primary'));
        card.classList.add('border-primary');
        state.selected = {
          id: +card.dataset.id,
          codigo: card.dataset.codigo,
          nombre: card.dataset.nombre,
          precio: card.dataset.precio,
          stock: +card.dataset.stock || 0,
          con_iva: card.dataset.coniva === '1'
        };
        // Autocompletar precio si está vacío
        if (!precioInput.value){
          precioInput.value = state.selected.precio;
        }
      });
    });
  }

  async function load(append=false){
    const params = new URLSearchParams({
      q: state.q,
      page: state.page,
      page_size: 24
    });
    const resp = await fetch(`${apiUrl}?${params.toString()}`, {headers: {'X-Requested-With':'XMLHttpRequest'}});
    const data = await resp.json();
    state.hasNext = !!data.has_next;
    const newItems = data.results || [];
    if (append){
      state.items = state.items.concat(newItems);
    }else{
      state.items = newItems;
    }
    render(append);
  }

  const doSearch = debounce(() => {
    state.q = (inputBuscar.value || '').trim();
    state.page = 1;
    state.selected = null;
    state.items = [];
    load(false);
  }, 250);

  // Agregar producto → tabla principal
  function addSelectedToTable(){
    if (!state.selected){
      // Si no hay selección, intenta seleccionar la primera card visible
      const firstCard = grid.querySelector('.product-card');
      if (firstCard) firstCard.click();
      if (!state.selected) return;
    }
    const cantidad = Math.max(1, parseInt(cantInput.value || '1', 10));
    const precio = parseFloat(precioInput.value || state.selected.precio || '0') || 0;
    const aplicaIva = !!chkIva.checked;

    const productData = {
      id: state.selected.id,
      codigo: state.selected.codigo,
      nombre: state.selected.nombre,
      precio: precio,
      cantidad: cantidad,
      aplica_iva: aplicaIva,
      con_iva: state.selected.con_iva
    };

    // 1) Si tu factura.js expone una función global, la usamos
    if (window.addProductoFromCatalog) {
      window.addProductoFromCatalog(productData);
    } else {
      // 2) Fallback simple: añadimos una fila básica
      const tbody = document.getElementById('tbody-productos');
      if (!tbody) return;
      const empty = tbody.querySelector('.empty-row'); if (empty) empty.remove();

      const total = (productoTotal(productData)).toFixed(2);

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(productData.nombre)}<div class="small text-muted">#${escapeHtml(productData.codigo||'')}</div></td>
        <td><input type="number" step="0.01" class="form-control form-control-sm price-input" value="${precio.toFixed(2)}"></td>
        <td><input type="number" min="1" class="form-control form-control-sm qty-input" value="${cantidad}"></td>
        <td><input type="number" min="0" max="100" class="form-control form-control-sm disc-input" value="0"></td>
        <td class="text-nowrap vgrav">$0.00</td>
        <td class="text-nowrap ivaitem">$0.00</td>
        <td class="text-nowrap total">$${total}</td>
        <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="bi bi-x-lg"></i></button></td>
      `;
      tbody.appendChild(tr);

      // listeners mínimos
      tr.querySelector('.btn-remove').addEventListener('click', ()=> tr.remove());
      tr.querySelectorAll('.price-input,.qty-input,.disc-input').forEach(inp=>{
        inp.addEventListener('input', ()=> {
          const p = parseFloat(tr.querySelector('.price-input').value||'0')||0;
          const q = parseInt(tr.querySelector('.qty-input').value||'1', 10)||1;
          const d = Math.min(100, Math.max(0, parseFloat(tr.querySelector('.disc-input').value||'0')||0));
          const t = (p*q*(1 - d/100)).toFixed(2);
          tr.querySelector('.total').textContent = `$${t}`;
        });
      });
    }

    // Reset rápido
    cantInput.value = 1;
    // precioInput.value = ''; // si prefieres limpiar
    bootstrap.Modal.getInstance(modal)?.hide();
  }

  function productoTotal(p){ return (p.precio * p.cantidad); }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  // Eventos
  modal?.addEventListener('shown.bs.modal', () => {
    inputBuscar?.focus();
    state.q = '';
    state.page = 1;
    state.items = [];
    state.selected = null;
    load(false);
  });

  inputBuscar?.addEventListener('input', doSearch);
  document.getElementById('btnMenosCant')?.addEventListener('click', ()=> inputBuscar?.focus());
  document.getElementById('btnMasCant')?.addEventListener('click', ()=> inputBuscar?.focus());
  btnAdd?.addEventListener('click', addSelectedToTable);

  // Enter agrega, Esc cierra (ya tienes manejo en tu script original)
  modal?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); addSelectedToTable(); }
  });
})();
</script>


