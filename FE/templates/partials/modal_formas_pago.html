<div class="modal fade" id="formasPagoModal" tabindex="-1" aria-labelledby="formasPagoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="formasPagoLabel" class="modal-title"><i class="bi bi-wallet2 me-2"></i> Formas de pago</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label">Método</label>
            <select id="metodo_fp" class="form-select">
              <option value="EFECTIVO">Efectivo</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="TRANSFERENCIA">Transferencia</option>
              <option value="OTRO">Otro</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Monto</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" step="0.01" min="0" id="monto_fp" class="form-control" placeholder="0.00">
            </div>
          </div>
          <div class="col-md-4 d-grid">
            <button type="button" class="btn btn-primary" id="btnAgregarFP"><i class="bi bi-plus-circle me-1"></i> Añadir</button>
          </div>
        </div>

        <div class="mt-3">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead class="table-light"><tr><th>Método</th><th>Monto</th><th class="text-end">Acciones</th></tr></thead>
              <tbody id="tbody-fp">
                <tr class="empty-row"><td colspan="3" class="text-center text-muted">Sin pagos aún</td></tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between">
            <div class="small text-muted">Total a pagar: $<span id="fp-total-pagar">0.00</span></div>
            <div class="small"><strong>Recibido: $<span id="fp-total-recibido">0.00</span></strong></div>
          </div>
          <div class="mt-2" id="fila-efectivo" hidden>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text">Recibido</span>
                  <input type="number" step="0.01" min="0" id="efectivo_recibido" class="form-control" placeholder="0.00">
                </div>
              </div>
              <div class="col-md-6">
                <div class="input-group">
                  <span class="input-group-text">Cambio</span>
                  <input type="text" id="efectivo_cambio" class="form-control" placeholder="0.00" readonly>
                </div>
              </div>
            </div>
            <small class="text-muted">Calculado automáticamente al cerrar.</small>
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <small class="text-muted">Enter añade – Esc cierra</small>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Listo</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const modal = document.getElementById('formasPagoModal');
  function toggleEfectivoUI() {
    const met = document.getElementById('metodo_fp')?.value;
    document.getElementById('fila-efectivo').hidden = (met !== 'EFECTIVO');
  }
  modal?.addEventListener('shown.bs.modal', () => {
    document.getElementById('metodo_fp')?.focus();
    document.getElementById('fp-total-pagar').textContent = document.getElementById('total-pagar')?.textContent || '0.00';
    toggleEfectivoUI();
  });
  document.getElementById('metodo_fp')?.addEventListener('change', toggleEfectivoUI);

  modal?.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') { e.preventDefault(); bootstrap.Modal.getInstance(modal)?.hide(); }
    if (e.key === 'Enter') { e.preventDefault(); document.getElementById('btnAgregarFP')?.click(); }
  });
})();
</script>
