{% extends "base.html" %}
{% load querystring_extras %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">Listado de Facturas Emitidas</h1>
  
  <!-- Formulario de filtrado -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label for="recibido_mh" class="form-label">Recibido por Hacienda:</label>
      <select name="recibido_mh" id="recibido_mh" class="form-select">
        <option value="">Todos</option>
        <option value="True" {% if request.GET.recibido_mh == "True" %}selected{% endif %}>Sí</option>
        <option value="False" {% if request.GET.recibido_mh == "False" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="sello_recepcion" class="form-label">Sello de Recepcion:</label>
      <input type="text" name="sello_recepcion" id="sello_recepcion" value="{{ request.GET.sello_recepcion }}" class="form-control">
    </div>
    <div class="col-md-3">
      <label for="has_sello_recepcion" class="form-label">¿Tiene Sello de Recepcion?</label>
      <select name="has_sello_recepcion" id="has_sello_recepcion" class="form-select">
        <option value="">Todos</option>
        <option value="yes" {% if request.GET.has_sello_recepcion == "yes" %}selected{% endif %}>Sí</option>
        <option value="no" {% if request.GET.has_sello_recepcion == "no" %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="tipo_dte" class="form-label">Tipo de Factura:</label>
      <select name="tipo_dte" id="tipo_dte" class="form-select">
        <option value="">Todos</option>
        {% for tipo in tipos_dte %}
          <option value="{{ tipo.id }}" {% if request.GET.tipo_dte == tipo.id|stringformat:"s" %}selected{% endif %}>{{ tipo.descripcion }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-15">
      <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>
  </form>
  
  <!-- Botón para invalidar las facturas seleccionadas -->
  <button id="btnInvalidarSeleccionadas" class="btn btn-danger mb-3">Anular seleccionadas</button>

  <!-- Botón para invalidar las facturas seleccionadas -->
  <a href="{% url 'exportar_facturas_excel' %}" class="btn btn-success">Facturas sin anular (Excel)</a>

  <!-- Tabla de Facturas -->
  <form id="formInvalidarFacturas">
    {% csrf_token %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead class="table-dark">
          <tr>
            <th>
              <!-- Checkbox para seleccionar/des-seleccionar todas -->
              <input type="checkbox" id="seleccionarTodo">
            </th>
            <th>Estado</th>
            <th>Número de Control</th>
            <th>Tipo de Factura</th>
            <th>Sello Recepcion</th>
            <th>Fecha de Emisión</th>
            <th>Total Factura</th>
            <th>IVA</th>
            <th>Recibido por Hacienda</th>
            <th>Acciones</th>
            <th>Correo enviado</th>
            <th>Enviar correo</th>
          </tr>
        </thead>
        <tbody>


          
          {% for factura in dtelist %}
          <tr>
            <td>
              <input type="checkbox" name="factura_ids" value="{{ factura.id }}">
            </td>
            <td>
              {% if factura.dte_invalidacion.all|length > 0 %}
                {% with evento=factura.dte_invalidacion.all.0 %}
                  {% if evento.recibido_mh %}
                    <i class="bi bi-x-octagon-fill text-danger" title="Anulada"></i>
                  {% else %}
                    <i class="bi bi-hourglass-split text-warning" title="En proceso de anulación"></i>
                  {% endif %}
                {% endwith %}
              {% else %}
                <i class="bi bi-check-circle-fill text-success" title="Viva"></i>
              {% endif %}
            </td>
            <td>{{ factura.numero_control }}</td>
            <td>
              {% if factura.tipo_dte.codigo == "03" %}
                CCF
              {% elif factura.tipo_dte.codigo == "01" %}
                FE
              {% else %}
                {{ factura.tipo_dte.codigo }}
              {% endif %}
            </td>
            <td>{{ factura.sello_recepcion }}</td>
            <td>{{ factura.fecha_emision }}</td>
            <td>{{ factura.total_pagar }}</td>
            <td>{{ factura.total_iva }}</td>
            <td>{% if factura.recibido_mh %}Sí{% else %}No{% endif %}</td>
            <td>
              {% if factura.recibido_mh %}
                <!-- Acción individual (opcional) -->
                <a href="{% url 'invalidar_dte_unificado' factura.id %}" class="btn btn-sm btn-secondary btn-invalidar" data-factura-id="{{ factura.id }}">Anular</a>
              {% endif %}
            </td>
            <td>{% if factura.envio_correo %}Sí{% else %}No{% endif %}</td>
            <td>
              <a href="{% url 'enviar_correo_individual' factura.id %}" class="btn btn-sm btn-secondary btn-invalidar" data-factura-id="{{ factura.id }}">Enviar</a>
            </td>
            <td>
              <a href="{% url 'detalle_factura' factura.id %}" class="btn btn-sm btn-secondary btn-invalidar" data-factura-id="{{ factura.id }}">Ver</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center">No se encontraron facturas.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
  
  <!-- Modal para mostrar respuesta -->
  <div class="modal fade" id="respuestaModal" tabindex="-1" aria-labelledby="respuestaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="respuestaModalLabel">Resultado de la Invalidación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div id="resultadoInvalidacion"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Paginación -->
  {% remove_query_param 'page' as query_params %}
  {% if dtelist.has_other_pages %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      <!-- Paginación existente -->
      {% if dtelist.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{{ query_params }}{% if query_params %}&{% endif %}page={{ dtelist.previous_page_number }}" aria-label="Anterior">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&laquo;</span>
      </li>
      {% endif %}
      
      <li class="page-item disabled">
        <span class="page-link">
          Página {{ dtelist.number }} de {{ dtelist.paginator.num_pages }}
        </span>
      </li>
      
      {% if dtelist.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{{ query_params }}{% if query_params %}&{% endif %}page={{ dtelist.next_page_number }}" aria-label="Siguiente">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link">&raquo;</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- JavaScript para manejar la selección y la llamada AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('formInvalidarFacturas');
  const btnInvalidar = document.getElementById('btnInvalidarSeleccionadas');
  const seleccionarTodo = document.getElementById('seleccionarTodo');
  const modalEl = document.getElementById('respuestaModal');
  const resultadoDiv = document.getElementById('resultadoInvalidacion');
  const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');

  // Habilitar / deshabilitar botón según selección
  function toggleBoton() {
    const anyChecked = form.querySelectorAll('input[name="factura_ids"]:checked').length > 0;
    btnInvalidar.disabled = !anyChecked;
  }
  toggleBoton();

  // Seleccionar/des-seleccionar todas
  if (seleccionarTodo) {
    seleccionarTodo.addEventListener('change', function(){
      form.querySelectorAll('input[name="factura_ids"]').forEach(chk => chk.checked = seleccionarTodo.checked);
      toggleBoton();
    });
  }

  // Detectar cambios por fila
  form.addEventListener('change', function(e){
    if (e.target && e.target.name === 'factura_ids') toggleBoton();
  });

  // Click en “Anular seleccionadas”
  btnInvalidar.addEventListener('click', function(e){
    e.preventDefault();

    const formData = new FormData(form);
    // Seguridad mínima: si no hay seleccionadas, no enviar
    if (!form.querySelector('input[name="factura_ids"]:checked')) return;

    btnInvalidar.disabled = true;
    btnInvalidar.innerHTML = 'Anulando...';

    fetch("{% url 'invalidar_varias_dte' %}", {
      method: 'POST',
      body: formData,
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfInput ? csrfInput.value : ''
      }
    })
    .then(r => r.json())
    .then(data => {
      // Construir el resumen para el modal
      let htmlResultado = '';
      if (data.results && data.results.length) {
        data.results.forEach(result => {
          htmlResultado += `<p><strong>Factura ${result.factura_id}:</strong> ${result.mensaje}`;
          if (result.detalle) {
            let detTxt;
            try { detTxt = typeof result.detalle === 'string' ? result.detalle : JSON.stringify(result.detalle); }
            catch { detTxt = ''; }
            if (detTxt) htmlResultado += `<br><small>${detTxt}</small>`;
          }
          htmlResultado += `</p>`;

          // Actualiza visualmente la fila si fue anulada OK
          if (result.exito || /anulada/i.test(result.mensaje)) {
            const rowChk = form.querySelector(`input[name="factura_ids"][value="${result.factura_id}"]`);
            if (rowChk) {
              const row = rowChk.closest('tr');
              const estadoCell = row ? row.children[1] : null; // 2da celda = estado (ajusta si tu orden cambia)
              if (estadoCell) {
                estadoCell.innerHTML = `<i class="bi bi-x-octagon-fill text-danger" title="Anulada"></i>`;
              }
              // Si quieres, desmarca la fila anulada:
              rowChk.checked = false;
            }
          }
        });
      } else {
        htmlResultado = "<p>No se recibió respuesta.</p>";
      }

      resultadoDiv.innerHTML = htmlResultado;
      const myModal = bootstrap.Modal.getOrCreateInstance(modalEl);
      myModal.show();
    })
    .catch(err => {
      console.error(err);
      resultadoDiv.innerHTML = `<p class="text-danger">Error al anular: ${err}</p>`;
      const myModal = bootstrap.Modal.getOrCreateInstance(modalEl);
      myModal.show();
    })
    .finally(() => {
      btnInvalidar.disabled = false;
      btnInvalidar.innerHTML = 'Anular seleccionadas';
      toggleBoton();
    });
  });
});
</script>


{% endblock %}