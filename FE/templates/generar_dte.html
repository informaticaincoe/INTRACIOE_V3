{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'fe/css/factura.css' %}">
<div class="container mt-5">
  <div class="card shadow p-4">
    <h2 class="text-center mb-4">Generar Factura Electrónica</h2>

    <!-- Stepper -->
    <ol class="stepper" aria-label="Progreso">
      <li class="active" data-step="1">Config.</li>
      <li data-step="2">Receptor</li>
      <li data-step="3">Doc. Rel.</li>
      <li data-step="4">Productos</li>
      <li data-step="5">Pago</li>
      <li data-step="6">Resumen</li>
    </ol>

    <!-- Datos del Emisor (solo lectura) -->
    {% if emisor %}
    <div class="mb-3 info-box">
      <div class="d-flex align-items-center gap-2">
        <h4 class="mb-0">Datos del Emisor</h4>
        <span class="text-muted small">Solo lectura</span>
      </div>
      <div class="row mt-2">
        <div class="col-md-3"><strong>NIT:</strong> {{ emisor.nit }}</div>
        <div class="col-md-3"><strong>Ambiente:</strong> {{ emisor.ambiente.descripcion }}</div>
        <div class="col-md-3"><strong>Teléfono:</strong> {{ emisor.telefono }}</div>
        <div class="col-md-3"><strong>Email:</strong> {{ emisor.email }}</div>
        <div class="col-12"><strong>Dirección Comercial:</strong> {{ emisor.direccion_comercial }}</div>
      </div>
    </div>
    {% endif %}

    <form id="form-factura">
      <!-- PASO 1: Configuración -->
      <section class="form-section" data-step="1">
        <div class="section-header">
          <h4>1) Configuración de Factura</h4>
          <small class="text-muted">Define tipo de documento y condiciones</small>
        </div>
        <div class="row">
          <div class="col-md-4">
            <label for="condicion_op" class="form-label">Condición de Operación</label>
            <select id="condicion_op" name="condicion_operacion" class="form-select" required>
              {% for tipo in tipooperaciones %}
                <option value="{{ tipo.id }}">{{ tipo.descripcion }}</option>
              {% endfor %}
            </select>
            <div class="form-hint">Ej.: Contado, Crédito, etc.</div>
          </div>

          <div class="col-md-4">
            <label for="tipo_documento_select" class="form-label">Tipo de Documento</label>
            <select name="tipo_documento_seleccionado" class="form-select" id="tipo_documento_select" required data-bs-toggle="tooltip" title="Cambia la forma de calcular el IVA">
              {% for dte in tipoDocumentos %}
                <option value="{{ dte.codigo }}" {% if dte.codigo == documento_seleccionado %}selected{% endif %}>{{ dte.descripcion }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label d-block">Retenciones</label>
            <div class="d-flex gap-3 align-items-center">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="retencion_iva_checkbox">
                <label class="form-check-label" for="retencion_iva_checkbox">Ret. IVA</label>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-retencion-iva" style="display:none;" data-bs-toggle="modal" data-bs-target="#retencionIvaModal">Configurar</button>

              <div class="form-check ms-3">
                <input class="form-check-input" type="checkbox" id="retencion_renta_checkbox">
                <label class="form-check-label" for="retencion_renta_checkbox">Ret. Renta</label>
              </div>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-retencion-renta" style="display:none;" data-bs-toggle="modal" data-bs-target="#retencionRentaModal">Configurar</button>
            </div>
          </div>

          <div class="col-md-4 mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="no_gravado_checkbox">
              <label class="form-check-label" for="no_gravado_checkbox">Base imponible</label>
            </div>
          </div>
        </div>

        <div class="row mt-3 g-3">
          <div class="col-md-3">
            <label for="numero_control_input" class="form-label">Número de Control</label>
            <input type="text" name="numero_control" class="form-control" readonly id="numero_control_input" value="{{ numero_control }}">
          </div>
          <div class="col-md-3">
            <label for="codigo_generacion_input" class="form-label">Código de Generación</label>
            <input type="text" id="codigo_generacion_input" name="codigo_generacion" class="form-control" readonly value="{{ codigo_generacion }}">
          </div>
          <div class="col-md-3">
            <label for="fecha_generacion_input" class="form-label">Fecha</label>
            <input type="date" id="fecha_generacion_input" name="fecha_generacion" class="form-control" readonly value="{{ fecha_generacion|date:'Y-m-d' }}">
          </div>
          <div class="col-md-3">
            <label for="hora_generacion_input" class="form-label">Hora</label>
            <input type="time" id="hora_generacion_input" name="hora_generacion" class="form-control" readonly value="{{ hora_generacion }}">
          </div>
        </div>

        <div class="section-footer">
          <button class="btn btn-primary btn-next" type="button" data-next="2">Continuar</button>
        </div>
      </section>

      <!-- PASO 2: Receptor -->
      <section class="form-section" data-step="2" hidden>
        <div class="section-header">
          <h4>2) Receptor</h4>
          <small class="text-muted">Selecciona o crea el receptor</small>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label for="receptor-select" class="form-label">Receptor</label>
            <select class="form-select" id="receptor-select" name="receptor_id" required>
              <option value="">Seleccione un receptor</option>
              {% for receptor in receptores %}
                <option value="{{ receptor.id }}">{{ receptor.num_documento }} - {{ receptor.nombre }}</option>
              {% endfor %}
              <option value="nuevo">Añadir nuevo receptor</option>
            </select>
          </div>
        </div>

        <div id="nuevo-receptor" class="mt-3" hidden>
          <div class="row g-3">
            <div class="col-md-4">
              <label for="nit_receptor_input" class="form-label">NIT</label>
              <input type="text" id="nit_receptor_input" name="nit_receptor" class="form-control" placeholder="0000-000000-000-0">
            </div>
            <div class="col-md-8">
              <label for="nombre_receptor_input" class="form-label">Nombre o Razón Social</label>
              <input type="text" id="nombre_receptor_input" name="nombre_receptor" class="form-control" placeholder="Empresa XYZ, S.A. de C.V.">
            </div>
            <div class="col-md-4">
              <label for="nrc_receptor_input" class="form-label">NRC</label>
              <input type="text" id="nrc_receptor_input" name="nrc_receptor" class="form-control" placeholder="123456-7">
            </div>
            <div class="col-md-8">
              <label for="direccion_receptor_input" class="form-label">Dirección</label>
              <textarea id="direccion_receptor_input" name="direccion_receptor" class="form-control" placeholder="Calle, número, municipio"></textarea>
            </div>
            <div class="col-md-4">
              <label for="telefono_receptor_input" class="form-label">Teléfono</label>
              <input type="text" id="telefono_receptor_input" name="telefono_receptor" class="form-control" placeholder="7777-7777">
            </div>
            <div class="col-md-8">
              <label for="correo_receptor_input" class="form-label">Correo</label>
              <input type="email" id="correo_receptor_input" name="correo_receptor" class="form-control" placeholder="correo@dominio.com">
            </div>
          </div>
        </div>

        <div class="section-footer">
          <button class="btn btn-secondary btn-prev" type="button" data-prev="1">Atrás</button>
          <button class="btn btn-primary btn-next" type="button" data-next="3">Continuar</button>
        </div>
      </section>

      <!-- PASO 3: Documento relacionado -->
      <section class="form-section" data-step="3" hidden>
        <div class="section-header">
          <h4>3) Documentos Relacionados</h4>
          <small class="text-muted">Opcional, si corresponde</small>
        </div>

        <div class="row align-items-end g-3">
          <div class="col-md-5">
            <label for="documento_select" class="form-label">Tipo de documento</label>
            <select name="documento_seleccionado" class="form-select" id="documento_select">
              <option value="S">Seleccione</option>
              {% for tipo in tipoGenDocumentos %}
                <option value="{{ tipo.codigo }}">{{ tipo.descripcion }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4" id="div-electronic" hidden>
            <label for="documento_relacionado_input" class="form-label">Documento (Electrónico)</label>
            <input type="text" name="documento_relacionado" class="form-control" id="documento_relacionado_input" placeholder="Código de generación">
          </div>

          <div class="col-md-4" id="div-physical" hidden>
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-outline-secondary w-100" id="btn-doc-fisico">+ Físico</button>
          </div>

          <div class="col-md-3">
            <button type="button" class="btn btn-outline-primary" id="btn_add_relacion" hidden>Agregar</button>
          </div>

          <div class="col-12">
            <div class="small text-muted">Total Pagar documento relacionado: {{ total_pagar_doc_r }}</div>
          </div>
        </div>

        <div class="mt-3">
          <h5 class="mb-2">Facturas Relacionadas</h5>
          <div id="facturasAccordion" class="accordion slim-scroll">
            <div class="empty-state">No hay documentos relacionados.</div>
          </div>
        </div>

        <div class="section-footer">
          <button class="btn btn-secondary btn-prev" type="button" data-prev="2">Atrás</button>
          <button class="btn btn-primary btn-next" type="button" data-next="4">Continuar</button>
        </div>
      </section>

      <!-- PASO 4: Productos -->
      <section class="form-section" data-step="4" hidden>
        <div class="section-header">
          <h4>4) Productos</h4>
          <small class="text-muted">Agrega líneas de la factura</small>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#productosModal">
            + Productos
          </button>
        </div>

        <div class="table-responsive mt-3">
          <table id="tabla-productos" class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Producto</th>
                <th>P. Unit. (Neto)</th>
                <th>IVA Unit.</th>
                <th>Cantidad</th>
                <th>Total Neto</th>
                <th>Desc. ítem</th>
                <th>Ventas Grav.</th>
                <th>IVA ítem</th>
                <th>Aplica IVA</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody-productos">
              <tr class="empty-row">
                <td colspan="10" class="empty-state">No has agregado productos aún.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="section-footer">
          <button class="btn btn-secondary btn-prev" type="button" data-prev="3">Atrás</button>
          <button class="btn btn-primary btn-next" type="button" data-next="5">Continuar</button>
        </div>
      </section>

      <!-- PASO 5: Formas de pago -->
      <section class="form-section" data-step="5" hidden>
        <div class="section-header">
          <h4>5) Formas de Pago</h4>
          <small class="text-muted">Indica cómo se cubrirá el total</small>
        </div>
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#formasPagoModal">
            + Formas de Pago
          </button>
        </div>

        <div class="pay-status mt-2">
          <span><strong>Total a Pagar:</strong> $<span id="total-pagar-fp">0.00</span></span>
          <span class="divider">|</span>
          <span><strong>Recibido:</strong> $<span id="recibido">0.00</span></span>
        </div>

        <div class="section-footer">
          <button class="btn btn-secondary btn-prev" type="button" data-prev="4">Atrás</button>
          <button class="btn btn-primary btn-next" type="button" data-next="6">Continuar</button>
        </div>
      </section>

      <!-- PASO 6: Resumen y extensión -->
      <section class="form-section" data-step="6" hidden>
        <div class="section-header">
          <h4>6) Resumen y Extensión</h4>
          <small class="text-muted">Revisa totales y completa datos del responsable (si aplica)</small>
        </div>

        <div class="resumen">
          <div class="row">
            <div class="col-md-4"><p><strong>SubTotal Neto:</strong> $<span id="subtotal-neto">0.00</span></p></div>
            <div class="col-md-4"><p><strong>Total IVA:</strong> $<span id="total-iva">0.00</span></p></div>
            <div class="col-md-4"><p><strong>Sumatoria de ventas:</strong> $<span id="total-incl">0.00</span></p></div>

            <div class="col-md-6">
              <label for="descuento-global" class="form-label mb-0">Descuento (%)</label>
              <input type="number" id="descuento-global" name="descuento_global_input" class="form-control" value="0" min="0" max="100">
            </div>
            <div class="col-md-6">
              <label for="descuento_gravado" class="form-label mb-0">Descuento (Ventas g.)</label>
              <input type="number" id="descuento_gravado" name="descuento_gravado_input" class="form-control" value="0" min="0" max="100">
            </div>

            <div class="col-md-6"><p class="mb-1"><strong>Monto Descuento:</strong> $<span id="monto_descuento" name="monto_descuento_input">0.00</span></p></div>
            <div class="col-md-6 d-flex align-items-center">
              <label for="saldo_favor_input" class="me-2 mb-0"><strong>Saldo a Favor:</strong></label>
              <input name="saldo_favor" id="saldo_favor_input" class="form-control" value="0" style="max-width:160px">
            </div>
            <div class="col-md-6"><p class="mb-1"><strong>Sub Total:</strong> $<span id="sub-total-resumen">0.00</span></p></div>
            <div class="col-md-6"><p class="mb-1"><strong>Valor tributo:</strong> $<span id="monto_tributo" name="tributo_input" class="tributo-input">0.00</span></p></div>
            <div class="col-md-6"><p class="mb-1"><strong>Monto Total Op.:</strong> $<span id="total-operacion">0.00</span></p></div>
            <div class="col-md-6"><p class="mb-1"><strong>Total a Pagar:</strong> $<span id="total-pagar">0.00</span></p></div>
          </div>
        </div>

        <div class="mt-3">
          <h5>Extensión</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="nombre_responsable" class="form-label">Nombre responsable</label>
              <input type="text" id="nombre_responsable" name="resp_nombre_input" class="form-control" placeholder="Nombre del Responsable">
              <div class="form-hint">Obligatorio si Nota de Crédito ≥ $25,000</div>
            </div>
            <div class="col-md-6">
              <label for="documento_responsable" class="form-label">Número de documento del responsable</label>
              <input type="text" id="documento_responsable" name="resp_documento_input" class="form-control" placeholder="DUI/NIT">
            </div>
          </div>
        </div>

        <div class="section-footer d-grid mt-3">
          <button id="btn-generar" type="submit" class="btn btn-primary">Generar Factura</button>
          <div id="form-errors" class="form-errors" aria-live="polite"></div>
        </div>
      </section>
    </form>
  </div>
</div>

<!-- Modales -->
{% include "partials/modal_productos.html" %}
{% include "partials/modal_doc_fisico.html" %}
{% include "partials/modal_formas_pago.html" %}
{% include "partials/modal_ret_iva.html" %}
{% include "partials/modal_ret_renta.html" %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'fe/js/factura.js' %}"></script>
{% endblock %}
