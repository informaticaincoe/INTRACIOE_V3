{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
  .kbd{border:1px solid #d0d7de;border-bottom-width:2px;border-radius:4px;padding:0 .25rem;font-size:.85em;background:#f8fafc}
  .pos-sticky{position:sticky;top:76px}
  .table-sm td .form-control-sm{min-height: calc(1.5em + .5rem + 2px)}
  .stock-low{color:#dc3545}
  .stock-ok{color:#6c757d}
  .combo-menu{display:none;max-height:260px;overflow:auto;border:1px solid #e5e7eb;border-radius:.5rem;margin-top:.25rem;background:#fff}
  .combo-item.active{background:#eef2ff}
</style>

<div class="container py-3">
  <form method="post" id="form-pos" autocomplete="off">
    {% csrf_token %}

    <!-- Encabezado -->
    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
      <div class="me-auto">
        <h4 class="mb-0">Facturación rápida</h4>
        <small class="text-muted">
          {% if emisor and emisor.imprime_termica or Emisor_fe and Emisor_fe.imprime_termica %}
            Documento → Cliente → Productos → Pago
          {% else %}
            Documento → Cliente → Productos → Pago → Extras
          {% endif %}
        </small>
      </div>
      <div class="text-end">
        <div class="small text-muted">No. control</div>
        <div class="fw-semibold" id="numero_control_text">{{ numero_control|default:"—" }}</div>
        <input type="hidden" name="numero_control" id="numero_control_input" value="{{ numero_control }}">
        {% if codigo_generacion %}
          <input type="hidden" name="codigo_generacion" value="{{ codigo_generacion }}">
        {% endif %}
      </div>
    </div>

    <div class="row g-3">
      <!-- Columna izquierda -->
      <div class="col-lg-8">

      {% if emisor and emisor.imprime_termica or Emisor_fe and Emisor_fe.imprime_termica %}
        {# ================== MODO TÉRMICA (solo datos factura, cliente, productos) ================== #}

        <!-- 1) Tipo de documento -->
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">1) Tipo de documento</h6>
              <small class="text-muted">Obligatorio</small>
            </div>
            <label class="form-label small mb-1">Seleccione el tipo de DTE</label>
            <select name="tipo_documento_seleccionado" id="tipo_documento_seleccionado" class="form-select" required>
              {% for d in tipoDocumentos %}
                <option value="{{ d.codigo }}"
                  {% if dte_select == d.codigo or forloop.first and not documento_seleccionado %}selected{% endif %}>
                  {{ d.descripcion }} 
                </option>
              {% endfor %}
            </select>
          </div>
        </div>
        <!-- 2) Cliente (sin condición de operación) -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">2) Cliente</h6>
              <small class="text-muted">Obligatorio</small>
              <a href="{% url "clientes_crear" %}"><i class="bi bi-pen" data-bs-toggle="tooltip" data-bs-placement="left" title="Agregar"></i></a>
            </div>
            <label class="form-label small mb-1">Seleccione cliente</label>
            <select name="receptor_id" id="receptor_id" class="form-select" required data-varios-id="1">
              <option value="">— Seleccione —</option>
              {% for r in receptores %}
                <option value="{{ r.id }}">{{ r.num_documento }} — {{ r.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- 3) Productos -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">3) Productos</h6>
              <small class="text-muted">Buscar por código o nombre. Enter agrega.</small>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-md-2">
                <label class="form-label small mb-1">Cant.</label>
                <input type="number" min="1" value="1" id="cantidadProducto" class="form-control text-center">
              </div>
              <div class="col-md-6">
                <label class="form-label small mb-1">Producto</label>
                <div class="combobox" id="productoPicker">
                  <input type="text" class="form-control" id="productoPickerInput" placeholder="Busca por código o nombre… (↑/↓, Enter)">
                  <div class="combo-menu" id="productoPickerMenu" role="listbox" aria-label="Productos"></div>
                </div>
                <div class="form-text">Tip: escanea o escribe; Enter selecciona.</div>
              </div>
              
              <div class="col-md-2">
                <label class="form-label small mb-1">Precio</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" min="0" id="precioProducto" class="form-control">
                </div>
              </div>
              <div class="col-12">
                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" id="aplicaIvaProducto" checked>
                  <label class="form-check-label" for="aplicaIvaProducto">Aplica IVA (13%)</label>
                </div>
              </div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-sm align-middle" id="tabla-items">
                <thead class="table-light">
                  <tr>
                    <th style="width:40%">Producto</th>
                    <th class="text-end" style="width:10%">Precio</th>
                    <th class="text-end" style="width:10%">Cant.</th>
                    <th class="text-center" style="width:10%">IVA</th>
                    <th class="text-end" style="width:10%">Total</th>
                    <th class="text-end" style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="tbody-items">
                  <tr class="empty">
                    <td colspan="6" class="text-center text-muted py-3">Sin productos agregados.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      {% else %}
        {# ================== MODO COMPLETO (todo) ================== #}

        <!-- 1) Tipo de documento -->
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">1) Tipo de documento</h6>
              <small class="text-muted">Obligatorio</small>
            </div>
            <label class="form-label small mb-1">Seleccione el tipo de DTE</label>
            <select name="tipo_documento_seleccionado" id="tipo_documento_seleccionado" class="form-select" required>
              {% for d in tipoDocumentos %}
                <option value="{{ d.codigo }}"
                  {% if dte_select == d.codigo or forloop.first and not documento_seleccionado %}selected{% endif %}>
                  {{ d.descripcion }}
                </option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- 2) Cliente + Condición -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">2) Cliente</h6>
              <small class="text-muted">Obligatorio</small>
            </div>
            <div class="row g-2">
              <div class="col-md-8">
                <label class="form-label small mb-1">Seleccione cliente</label>
                <select name="receptor_id" id="receptor_id" class="form-select" required>
                  <option value="">— Seleccione —</option>
                  {% for r in receptores %}
                    <option value="{{ r.id }}">{{ r.num_documento }} — {{ r.nombre }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small mb-1">Condición</label>
                <select name="condicion_operacion" id="condicion_op" class="form-select" required>
                  {% for t in tipooperaciones %}
                    <option value="{{ t.id }}">{{ t.descripcion }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- 3) Productos -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0">3) Productos</h6>
              <small class="text-muted">Buscar por código o nombre. Enter agrega.</small>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label small mb-1">Producto</label>
                <div class="combobox" id="productoPicker">
                  <input type="text" class="form-control" id="productoPickerInput" placeholder="Busca por código o nombre… (↑/↓ navega, Enter selecciona)">
                  <div class="combo-menu" id="productoPickerMenu" role="listbox" aria-label="Productos"></div>
                </div>
                <div class="form-text">Tip: escanea o escribe; Enter selecciona.</div>
              </div>
              <div class="col-md-2">
                <label class="form-label small mb-1">Cant.</label>
                <input type="number" min="1" value="1" id="cantidadProducto" class="form-control text-center">
              </div>
              <div class="col-md-2">
                <label class="form-label small mb-1">Precio</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" step="0.01" min="0" id="precioProducto" class="form-control">
                </div>
              </div>
              <div class="col-md-2 d-grid">
                <button type="button" id="btnAgregarProducto" class="btn btn-primary">
                  <i class="bi bi-plus-circle me-1"></i> Agregar
                </button>
              </div>
              <div class="col-12">
                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" id="aplicaIvaProducto" checked>
                  <label class="form-check-label" for="aplicaIvaProducto">Aplica IVA (13%)</label>
                </div>
              </div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-sm align-middle" id="tabla-items">
                <thead class="table-light">
                  <tr>
                    <th style="width:40%">Producto</th>
                    <th class="text-end" style="width:10%">Precio</th>
                    <th class="text-end" style="width:10%">Cant.</th>
                    <th class="text-center" style="width:10%">IVA</th>
                    <th class="text-end" style="width:10%">Total</th>
                    <th class="text-end" style="width:10%"></th>
                  </tr>
                </thead>
                <tbody id="tbody-items">
                  <tr class="empty">
                    <td colspan="6" class="text-center text-muted py-3">Sin productos agregados.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 5) Extras -->
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <a class="d-flex align-items-center justify-content-between text-decoration-none" data-bs-toggle="collapse" href="#extrasCollapse" role="button" aria-expanded="false" aria-controls="extrasCollapse">
              <h6 class="mb-0">5) Extras</h6>
              <i class="bi bi-chevron-down"></i>
            </a>
            <div class="collapse mt-3" id="extrasCollapse">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="border rounded p-3">
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="ret_iva_sw" name="retencion_iva">
                      <label class="form-check-label" for="ret_iva_sw">Retención IVA</label>
                    </div>
                    <div class="row g-2">
                      <div class="col-6">
                        <label class="form-label small mb-1">Porcentaje</label>
                        <input type="number" step="0.01" min="0" id="ret_iva_pct" class="form-control" value="1.00">
                        <input type="hidden" name="porcentaje_retencion_iva" id="porcentaje_retencion_iva" value="1.00">
                      </div>
                      <div class="col-6">
                        <label class="form-label small mb-1">Monto</label>
                        <input type="number" step="0.01" min="0" id="ret_iva_mto" class="form-control" value="0.00">
                      </div>
                    </div>
                    <hr class="my-3">
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="ret_renta_sw" name="retencion_renta">
                      <label class="form-check-label" for="ret_renta_sw">Retención Renta</label>
                    </div>
                    <div class="row g-2">
                      <div class="col-6">
                        <label class="form-label small mb-1">Monto</label>
                        <input type="number" step="0.01" min="0" id="ret_renta_mto" class="form-control" value="0.00">
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="border rounded p-3">
                    <label class="form-label small">Documento relacionado (opcional)</label>
                    <div class="row g-2 mb-2">
                      <div class="col-5">
                        <select class="form-select" name="documento_seleccionado">
                          <option value="S">— Sin relación —</option>
                          <option value="1">Físico</option>
                          <option value="2">Electrónico</option>
                        </select>
                      </div>
                      <div class="col-7">
                        <input type="text" name="documento_relacionado" class="form-control" placeholder="Código de generación o ref. física">
                      </div>
                    </div>

                    <label class="form-label small mb-1">Extensión (responsable)</label>
                    <div class="row g-2">
                      <div class="col-6">
                        <input type="text" name="nombre_responsable" class="form-control" placeholder="Nombre responsable">
                      </div>
                      <div class="col-6">
                        <input type="text" name="documento_responsable" class="form-control" placeholder="DUI/NIT">
                      </div>
                    </div>

                    <div class="form-check form-switch mt-3">
                      <input class="form-check-input" type="checkbox" id="no_gravado" name="no_gravado">
                      <label class="form-check-label" for="no_gravado">Base imponible (servicios / no gravado)</label>
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label small mb-1">Observaciones</label>
                  <textarea class="form-control" name="observaciones" rows="2" placeholder="Opcional"></textarea>
                </div>
              </div>
            </div>
          </div>
        </div>

      {% endif %}
      </div>

      <!-- Columna derecha: Métodos de pago + Resumen -->
      <div class="col-lg-4">
        <div class="card shadow-sm pos-sticky">
          <div class="card-body">

            <div class="mb-3">
              <label class="form-label small mb-1">4) Método de pago</label>
              <select class="form-select" name="metodo_pago" id="metodo_pago">
                {% if formas_pago %}
                  {% for f in formas_pago %}
                    <option value="{{ f.codigo }}">{{ f.descripcion }}</option>
                  {% endfor %}
                {% else %}
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="TARJETA">Tarjeta</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="CREDITO">Crédito</option>
                {% endif %}
              </select>
            </div>

            <!-- Campos condicionales de pago -->
            <div class="mb-3" id="wrap-efectivo" style="display:none">
              <label class="form-label small mb-1">Efectivo</label>
              <div class="input-group">
                <span class="input-group-text">Recibido</span>
                <input type="number" step="0.01" min="0" class="form-control" id="montoRecibido" value="">
              </div>
              <div class="small mt-1">Cambio: <span id="montoCambio">$0.00</span></div>
            </div>

            <div class="mb-3" id="wrap-credito" style="display:none">
              <div class="row g-2">
                <div class="col-4">
                  <label class="form-label small mb-1">Días crédito</label>
                  <input type="number" name="dias_credito" id="dias_credito" class="form-control" value="30" min="1">
                </div>
                <div class="col-8">
                  <label class="form-label small mb-1">Fecha venc.</label>
                  <input type="date" name="fecha_vencimiento" id="fecha_vencimiento" class="form-control">
                </div>
                <div class="col-12">
                  <label class="form-label small mb-1">Notas de pago</label>
                  <input type="text" name="notas_pago" class="form-control" placeholder="Opcional">
                </div>
              </div>
            </div>

            <h6 class="mb-3">Resumen</h6>
            <div class="d-flex justify-content-between small">
              <span>SubTotal Neto</span><strong id="sum_subtotal">$0.00</strong>
            </div>
            <div class="d-flex justify-content-between small">
              <span>IVA</span><strong id="sum_iva">$0.00</strong>
            </div>
            <div class="d-flex justify-content-between small">
              <span>Descuentos</span><strong id="sum_desc">$0.00</strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between fs-5">
              <span>Total a pagar</span><strong id="sum_total">$0.00</strong>
            </div>

            <div id="alert-clientes-varios"
                class="alert alert-warning d-none mt-2"
                role="alert"
              >
                <i class="bi bi-info-circle me-1"></i>
                <strong>Monto supera $20.00</strong>: selecciona un
                <b>cliente registrado</b> (no "Clientes varios").
            </div>

            <!-- hidden para backend -->
            <div id="hidden-items"></div>
            <input type="hidden" name="retencion_iva_monto" id="retencion_iva_monto">
            <input type="hidden" name="retencion_renta_monto" id="retencion_renta_monto">

            <div class="d-grid mt-3">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check2-circle me-1"></i> Generar DTE
              </button>
            </div>
            <div class="small text-muted mt-2">Atajos: Enter agrega · F9 generar · ESC limpia línea.</div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Modal: Error/Contingencia MH -->
<div class="modal fade" id="mhModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mhModalTitle">No se pudo enviar a Hacienda</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="mhModalMsg" class="mb-2"></div>
        <details id="mhModalDet" class="mb-2" style="display:none;">
          <summary class="small text-muted">Detalles técnicos</summary>
          <pre class="small mt-2" id="mhModalDetPre" style="white-space:pre-wrap;"></pre>
        </details>
        <div id="mhModalAviso" class="alert alert-warning py-2 px-3 mb-0" style="display:none;">
          ¿Deseas <strong>enviar en contingencia</strong> este DTE? (Se transmitirá más tarde)
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="btnGuardarSinEnviar" class="btn btn-warning" style="display:none;">
          Guardar sin enviar
        </button>
        <button type="button" id="btnReintentar" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Reintentar
        </button>
        <button type="button" id="btnContingencia" class="btn btn-primary">
          Enviar en contingencia
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const THRESHOLD_MH = 20; // USD
  const receptorSel   = document.getElementById('receptor_id');
  const alertClientes = document.getElementById('alert-clientes-varios');
  const form          = document.getElementById('form-pos');
  const submitBtn     = form ? form.querySelector('button[type="submit"]') : null;
  const receptorError = document.getElementById('receptor-error');

  //funcion para verificar que el cliente seleccionado es clientes varios
  function isClientesVariosSelected() {
    if (!receptorSel) return false;

    const selVal  = String(receptorSel.value || '');
    const selTxt  = (receptorSel.options[receptorSel.selectedIndex]?.text || '').toUpperCase();
    const variosId = String(receptorSel.dataset.variosId);  // data-varios-id="1"

    if (selVal && selVal === variosId) return true;
    if (selTxt.includes('VARIOS')) return true;
    if (selTxt.includes('0000000-0')) return true;


    return false;
  }

  // SOLO aplica la regla si hay ítems en el carrito
  function enforceClienteRequirement(totalPagar) {
    if (!alertClientes) return;

    const itemsCount = (window.POS?.items?.length || 0);

    // Si no hay productos -> todo normal
    if (!itemsCount) {
      alertClientes.classList.add('d-none');
      if (submitBtn) submitBtn.disabled = false;

      if (receptorSel) receptorSel.classList.remove('is-invalid');
      if (receptorError) receptorError.style.display = 'none';
      return;
    }

    const requiereCliente = Number(totalPagar) > THRESHOLD_MH;
    const esVarios        = isClientesVariosSelected();
    const bloquear        = requiereCliente && esVarios;

    // Mostrar / ocultar alert
    alertClientes.classList.toggle('d-none', !bloquear);

    // Bloquear / habilitar botón Generar DTE
    if (submitBtn) submitBtn.disabled = bloquear;

    // Marcar select como inválido
    if (receptorSel) {
      receptorSel.classList.toggle('is-invalid', bloquear);
    }
    if (receptorError) {
      receptorError.style.display = bloquear ? 'block' : 'none';
    }
  }

  // Cuando cambie el cliente, reevaluar con el total actual
  if (receptorSel) {
    receptorSel.addEventListener('change', () => {
      const txt   = document.getElementById('sum_total')?.textContent || '$0.00';
      const total = parseFloat(txt.replace(/[^\d.]/g, '')) || 0;
      enforceClienteRequirement(total);
    });
  }
</script>

<script>
  (function(){
    // ======= Estado global POS =======
    window.POS = {
      items: [],
      apiUrl: "{% url 'api_productos' %}",
    };

    
    // ======= Helpers / refs =======
    const $ = (id) => document.getElementById(id);
    const tbody       = $('tbody-items');
    const hiddenItems = $('hidden-items');
    const qtyInput    = $('cantidadProducto');
    const priceInput  = $('precioProducto');
    const ivaChk      = $('aplicaIvaProducto');
    const btnAgregar  = $('btnAgregarProducto');
    const sumSub  = $('sum_subtotal');
    const sumIva  = $('sum_iva');
    const sumDesc = $('sum_desc');
    const sumTot  = $('sum_total');

    const mpSelect = $('metodo_pago');

    function fmt(n){ return '$' + (Number(n||0).toFixed(2)); }
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    function _isEfectivoVal(value, label=''){
      const v = (value||'').toString().toUpperCase();
      const t = (label||'').toString().toUpperCase();
      return v === '01' || v === 'EFECTIVO' || t.includes('EFECT');
    }
    function _isCreditoVal(value, label=''){
      const v = (value||'').toString().toUpperCase();
      const t = (label||'').toString().toUpperCase();
      return v === '17' || v === 'CREDITO' || v === 'CRÉDITO' || t.includes('CRED');
    }

    function lineTotal(it){
      const subtotal = (+it.precio) * it.cantidad;
      const desc = subtotal * (Math.min(100, Math.max(0, +it.desc_pct))/100);
      const base = subtotal - desc;
      const iva = it.aplica_iva ? base * 0.13 : 0;
      return base + iva;
    }

    // --- Número de control por tipo DTE ---
    const tipoDteSelect = document.getElementById('tipo_documento_seleccionado');
    const ncText  = document.getElementById('numero_control_text');
    const ncInput = document.getElementById('numero_control_input');

    async function actualizarNumeroControl() {
      if (!tipoDteSelect) return;
      const tipo = tipoDteSelect.value;
      try {
        if (ncText) ncText.textContent = '…';
        const url = "{% url 'obtener_numero_control_ajax' %}?tipo_dte=" + encodeURIComponent(tipo);
        const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        const nuevo = data?.numero_control || '';
        if (ncText)  ncText.textContent  = nuevo || '—';
        if (ncInput) ncInput.value = nuevo;
      } catch (err) {
        console.error('Error obteniendo número de control:', err);
        if (ncText) ncText.textContent = 'Error';
      }
    }
    tipoDteSelect?.addEventListener('change', actualizarNumeroControl);
    actualizarNumeroControl();

    // ======= Hidden para backend =======
    function syncHidden(){
      hiddenItems.innerHTML = POS.items.map(it => `
        <input type="hidden" name="item_id[]" value="${it.id}">
        <input type="hidden" name="item_cantidad[]" value="${it.cantidad}">
        <input type="hidden" name="item_precio[]" value="${(+it.precio).toFixed(2)}">
        <input type="hidden" name="item_descuento[]" value="${it.desc_pct}">
        <input type="hidden" name="item_iva[]" value="${it.aplica_iva ? '1':'0'}">
        <input type="hidden" name="item_stock[]" value="${Number.isFinite(+it.stock)? it.stock : ''}">
      `).join('');
    }

    // ======= Render tabla =======
    function renderItems(){
      const items = POS.items;
      if (!items.length){
        tbody.innerHTML = `<tr class="empty"><td colspan="6" class="text-center text-muted py-3">Sin productos agregados.</td></tr>`;
        hiddenItems.innerHTML = '';
        return;
      }

      tbody.innerHTML = items.map((it, i) => {
        const stockTxt = Number.isFinite(+it.stock) ? it.stock : '-';
        const stockClass = (Number(it.stock) <= 0) ? 'stock-low' : 'stock-ok';
        return `
          <tr data-idx="${i}">
            <td>
              <div class="fw-semibold">${escapeHtml(it.nombre)}</div>
              <div class="small ${stockClass}">#${escapeHtml(it.codigo||'-')} · Stock: ${stockTxt}</div>
            </td>
            <td class="text-end">
              <input type="number" step="0.01" min="0" class="form-control form-control-sm text-end inp-precio" value="${(+it.precio).toFixed(2)}" aria-label="Precio unitario">
            </td>
            <td class="text-end">
              <input type="number" min="1" class="form-control form-control-sm text-end inp-cant" value="${it.cantidad}" aria-label="Cantidad">
            </td>
            <td class="text-center">
              <input class="form-check-input chk-iva" type="checkbox" ${it.aplica_iva ? 'checked':''} aria-label="Aplica IVA">
            </td>
            <td class="text-end cel-total">${fmt(lineTotal(it))}</td>
            <td class="text-end">
              <button type="button" class="btn btn-sm btn-outline-danger btn-del"><i class="bi bi-x-lg"></i></button>
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('tr').forEach(tr=>{
        const idx = +tr.dataset.idx;
        const item = POS.items[idx];

        tr.querySelector('.inp-precio').addEventListener('input', (e)=>{
          item.precio = parseFloat(e.target.value||'0')||0;
          tr.querySelector('.cel-total').textContent = fmt(lineTotal(item));
          calcTotals();
        });
        tr.querySelector('.inp-cant').addEventListener('input', (e)=>{
          item.cantidad = Math.max(1, parseInt(e.target.value||'80',10));
          tr.querySelector('.cel-total').textContent = fmt(lineTotal(item));
          calcTotals();
        });
        tr.querySelector('.chk-iva').addEventListener('change', (e)=>{
          item.aplica_iva = e.target.checked;
          tr.querySelector('.cel-total').textContent = fmt(lineTotal(item));
          calcTotals();
        });
        tr.querySelector('.btn-del').addEventListener('click', ()=>{
          POS.items.splice(idx,1);
          renderItems();
          calcTotals();
        });
      });

      syncHidden();
    }
    window.renderItems = renderItems;

    // ======= Totales =======
    function calcTotals(){
      let subtotal = 0, descuentos = 0, iva = 0, total = 0;
      POS.items.forEach(it=>{
        const st = (+it.precio) * it.cantidad;
        const ds = st * (Math.min(100, Math.max(0, +it.desc_pct))/100);
        const base = st - ds;
        const iv = it.aplica_iva ? base * 0.13 : 0;
        subtotal += base;
        descuentos += ds;
        iva += iv;
        total += base + iv;
      });

      // Extras (si existen en DOM)
      const retIvaOn = $('ret_iva_sw')?.checked;
      const retRentaOn = $('ret_renta_sw')?.checked;
      let retIvaMto = retIvaOn ? parseFloat($('ret_iva_mto')?.value||'0')||0 : 0;
      let retRentaMto = retRentaOn ? parseFloat($('ret_renta_mto')?.value||'0')||0 : 0;

      const totalPagar = total - retIvaMto - retRentaMto;

      sumSub.textContent  = fmt(subtotal);
      sumIva.textContent  = fmt(iva);
      sumDesc.textContent = fmt(descuentos);
      sumTot.textContent  = fmt(totalPagar);

      if ($('retencion_iva_monto'))   $('retencion_iva_monto').value   = retIvaMto.toFixed(2);
      if ($('retencion_renta_monto')) $('retencion_renta_monto').value = retRentaMto.toFixed(2);

      // Efectivo: calcular cambio
      const val   = mpSelect?.value || '';
      const label = mpSelect?.options[mpSelect.selectedIndex]?.text || '';
      if (_isEfectivoVal(val, label)) {
        const recibido = parseFloat($('montoRecibido')?.value||'0')||0;
        const cambio = Math.max(0, recibido - totalPagar);
        $('montoCambio') && ($('montoCambio').textContent = fmt(cambio));
      }

      // Reglas MH: exigir cliente si total > umbral
      enforceClienteRequirement(totalPagar);
      syncHidden();
    }
    window.calcTotals = calcTotals;


    // Eventos extras (si existen) y efectivo
    ['ret_iva_sw','ret_iva_mto','ret_renta_sw','ret_renta_mto','montoRecibido'].forEach(id=>{
      $(id)?.addEventListener?.('input', calcTotals);
      $(id)?.addEventListener?.('change', calcTotals);
    });

    // Agregar item desde picker
    function addItemFromProduct(sel){
      if(!sel) return;
      const cant   = Math.max(1, parseInt(qtyInput.value||'1',10));
      const aplica = ivaChk.checked;
      const precio = parseFloat(priceInput.value || sel.precio || '0') || 0;

      const idx = POS.items.findIndex(x => x.id === sel.id);
      if (idx >= 0) {
        POS.items[idx].cantidad += cant;
        if (!priceInput.value) POS.items[idx].precio = +sel.precio;
      } else {
        POS.items.push({
          id: sel.id,
          codigo: sel.codigo,
          nombre: sel.nombre,
          precio: precio,
          cantidad: cant,
          desc_pct: 0,
          aplica_iva: aplica,
          stock: sel.stock
        });
      }

      qtyInput.value = 1;
      renderItems();
      calcTotals();
    }
    window.addItem = () => {};

    // ======= Product Picker =======
    class ProductPicker {
      constructor({input, menu, apiUrl, onChoose}){
        this.input = input; this.menu = menu; this.apiUrl = apiUrl; this.onChoose = onChoose || (()=>{});
        this.items = []; this.activeIndex = -1; this.selected = null;

        this.input.addEventListener('focus', ()=> this.search(''));
        this.input.addEventListener('input',  (e)=> this.debouncedSearch(e.target.value.trim()));
        this.input.addEventListener('keydown',(e)=> this.onKey(e));
        document.addEventListener('click', (e)=>{ if(!this.menu.contains(e.target) && e.target!==this.input){ this.hide(); }});
      }
      debouncedSearch(q){ clearTimeout(this._t); this._t = setTimeout(()=>this.search(q), 180); }
      async search(q){
        try{
          const url = `${this.apiUrl}?q=${encodeURIComponent(q)}&page_size=25`;
          const res = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}, credentials: 'same-origin'});
          const data = await res.json();
          this.items = (data.results||[]).map(p=>{
            const precio = parseFloat(p.precio||'0')||0;
            const neto = p.con_iva ? (precio/1.13) : precio;
            const stockValue = parseFloat(p.stock);
            const stockFinal = Number.isFinite(stockValue) ? stockValue : 0;

            return { id:p.id, codigo:p.codigo, nombre:p.nombre||p.descripcion, precio:neto, stock:stockFinal };
          });
          this.activeIndex = this.items.length ? 0 : -1;
          this.render(); this.show();
        }catch(_e){ this.items=[]; this.activeIndex=-1; this.render(); this.show(); }
      }
      render(){
        if(!this.items.length){ this.menu.innerHTML = `<div class="combo-empty p-2 text-muted">Sin resultados…</div>`; return; }
        this.menu.innerHTML = this.items.map((it,i)=>`
          <div class="combo-item ${i===this.activeIndex?'active':''} p-2" role="option" data-idx="${i}" style="cursor:pointer;">
            <div class="d-flex align-items-center justify-content-between gap-3">
              <div class="me-3">
                <div class="fw-semibold">${this.escape(it.nombre)}</div>
                <div class="small ${(+it.stock)<=0?'text-danger':'text-success'}">
                  #${this.escape(it.codigo||'-')} · Stock: ${Number.isFinite(+it.stock)?it.stock:'-'}
                </div>
              </div>
              <div class="ms-auto text-nowrap">
                <span class="badge text-bg-light">$${(+it.precio).toFixed(2)}</span>
              </div>
            </div>
          </div>
        `).join('');
        this.menu.querySelectorAll('.combo-item').forEach(el=>{
          el.addEventListener('click', ()=>{
            const idx = +el.dataset.idx; this.choose(idx);
          });
        });
      }
      onKey(e){
        if(!this.isOpen()) this.show();
        if(e.key==='ArrowDown'){ e.preventDefault(); this.move(1); }
        else if(e.key==='ArrowUp'){ e.preventDefault(); this.move(-1); }
        else if(e.key==='Enter'){ e.preventDefault(); this.choose(this.activeIndex); }
        else if(e.key==='Escape'){ this.hide(); }
      }
      move(delta){
        if(!this.items.length) return;
        this.activeIndex = (this.activeIndex + delta + this.items.length) % this.items.length;
        this.render();
        this.menu.querySelector('.combo-item.active')?.scrollIntoView({block:'nearest'});
      }
      choose(idx){
        const item = this.items[idx]; if(!item) return;
        this.selected = item;
        this.input.value = `${item.codigo} | ${item.nombre}`;
        this.onChoose(item);
        this.hide();
      }
      getSelected(){ return this.selected; }
      focus(){ this.input.focus(); }
      isOpen(){ return this.menu.style.display!=='none'; }
      show(){ this.menu.style.display='block'; }
      hide(){ this.menu.style.display='none'; }
      escape(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    }

    const picker = new ProductPicker({
      input: $('productoPickerInput'),
      menu:  $('productoPickerMenu'),
      apiUrl: POS.apiUrl,
      onChoose: (prod)=>{
        priceInput.value = (+prod.precio).toFixed(2);
        priceInput.dataset.sticky = '1';
        ivaChk.checked = !prod.con_iva;
        setTimeout(()=>{ addItemFromProduct(prod); }, 10);
      }
    });
    window.PRODUCT_PICKER = picker;

    // Enter del input → agrega
    $('productoPickerInput')?.addEventListener('keydown', (e)=>{
      const sel = picker.getSelected();
      if(e.key==='Enter' && sel){
        e.preventDefault();
        addItemFromProduct(sel);
      }
    });

    // Botón Agregar
    $('btnAgregarProducto')?.addEventListener('click', ()=>{
      const sel = picker.getSelected();
      if(!sel){ picker.focus(); return; }
      addItemFromProduct(sel);
    });

    // Método de pago: mostrar/ocultar bloques
    function togglePago(){
      const val   = mpSelect?.value || '';
      const label = mpSelect?.options[mpSelect.selectedIndex]?.text || '';
      const isEf = _isEfectivoVal(val, label);
      const isCr = _isCreditoVal(val, label);
      const $ef = $('wrap-efectivo');
      const $cr = $('wrap-credito');
      if ($ef) $ef.style.display = isEf ? '' : 'none';
      if ($cr) $cr.style.display = isCr ? '' : 'none';
      calcTotals();
    }
    mpSelect?.addEventListener('change', togglePago);
    $('montoRecibido')?.addEventListener('input', calcTotals);
    togglePago();

    // ======= Modal de MH (si existe en el DOM) =======
    const MHModalEl = document.getElementById('mhModal');
    const MHModal   = MHModalEl && window.bootstrap ? new bootstrap.Modal(MHModalEl) : null;
    const $mTitle   = document.getElementById('mhModalTitle');
    const $mMsg     = document.getElementById('mhModalMsg');
    const $mDet     = document.getElementById('mhModalDet');
    const $mDetPre  = document.getElementById('mhModalDetPre');
    const $btnReint = document.getElementById('btnReintentar');
    const $btnCont  = document.getElementById('btnContingencia');

    function showMhModal(payload){
      if (!MHModal) {
        // Fallback si no hay modal en el DOM
        const msg = (payload?.titulo ? (payload.titulo + ': ') : '') + (payload?.mensaje || 'Error');
        alert(msg);
        return;
      }
      const titulo = payload?.titulo || 'No se pudo enviar a Hacienda';
      const mensaje = payload?.mensaje || 'Ocurrió un error al intentar enviar el DTE.';
      const detalles = payload?.detalles || payload?.respuesta || '';
      const puedeConting = !!payload?.puede_contingencia;
      const puedeGuardar = !!payload?.puede_guardar;
      const facturaId = payload?.factura_id;
      const enviarUrl = payload?.enviar_mh_url;
      const redirectUrl = payload?.redirect;

      $mTitle && ($mTitle.textContent = titulo);
      $mMsg && ($mMsg.textContent = mensaje);

      if ($mDet && $mDetPre) {
        if (detalles) {
          $mDet.style.display = '';
          $mDetPre.textContent = typeof detalles === 'string' ? detalles : JSON.stringify(detalles, null, 2);
        } else {
          $mDet.style.display = 'none';
          $mDetPre.textContent = '';
        }
      }
      const aviso = document.getElementById('mhModalAviso');
      if (aviso) aviso.style.display = puedeConting ? '' : 'none';

      // MOSTRAR/OCULTAR MODAL DE GUARDAR SIN Enviar
      if ($btnguardar){
        $btnGuardar.style.display = puedeGuardar ? '' : 'none';
        $btnGuardar.onclick = () => {
          MHModal.hide();
          if (redirectUrl) window.location.href = redirectUrl;
          else window.location.reload();
        };
      }

      if ($btnReint) {
        $btnReint.onclick = () => {
          setTimeout(()=> form.requestSubmit(), 120);
        };
      }

      if ($btnCont) {
        $btnCont.onclick = async () => {
          if (!enviarUrl || !facturaId) return;
          const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '';
          $btnCont.disabled = true;
          $btnCont.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Enviando…`;
          try {
            const idem = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
            const fd = new FormData();
            fd.append('csrfmiddlewaretoken', csrf);
            fd.append('crear_evento', 'true');
            fd.append('idempotency_key', idem);

            const resp = await fetch(`${enviarUrl}${enviarUrl.endsWith('/')?'':'/'}?crear_evento=true`, {
              method: 'POST',
              body: fd,
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              credentials: 'same-origin'
            });

            const ct = resp.headers.get('content-type') || '';
            const data = ct.includes('application/json') ? await resp.json() : {};
            if (resp.ok && (data.ok || data.redirect)) {
              MHModal.hide();
              if (data.redirect) window.location.href = data.redirect;
              else window.location.reload();
            } else {
              showMhModal({
                titulo: 'No se pudo crear contingencia',
                mensaje: data?.error || `HTTP ${resp.status}`,
                detalles: data
                //puede_guardar: true,
                //puede_contingencia: false
              });
            }
          } catch(e) {
            showMhModal({ titulo: 'Error de red', mensaje: String(e) });
          } finally {
            $btnCont.disabled = false;
            $btnCont.textContent = 'Enviar en contingencia';
          }
        };
      }

      MHModal.show();
    }

    // ======= Submit con fetch (anti-doble click + idempotencia + modal) =======
    const form = document.getElementById('form-pos');
    const genBtn = () => form.querySelector('button[type="submit"]');
    let SUBMITTING = false;

    function setSubmitting(on) {
      const b = genBtn();
      if (!b) return;
      if (on) {
        SUBMITTING = true;
        b.disabled = true;
        b.dataset.prev = b.innerHTML;
        b.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generando…`;
      } else {
        SUBMITTING = false;
        b.disabled = false;
        if (b.dataset.prev) b.innerHTML = b.dataset.prev;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (window.POS.items.length === 0) {
        e.preventDefault();
        alert('Agrega al menos un producto.');
        return;
      }
      if (SUBMITTING) { e.preventDefault(); return; }

      // >>> Bloqueo MH: total > 20 no permite "Clientes varios" (ID=1)
      // Recalcula totals por si el DOM no está actualizado al milisegundo
      let total = 0;
      window.POS.items.forEach(it => {
        const st = (+it.precio) * it.cantidad;
        const ds = st * (Math.min(100, Math.max(0, +it.desc_pct)) / 100);
        const base = st - ds;
        const iv = it.aplica_iva ? base * 0.13 : 0;
        total += base + iv;
      });

      const retIvaOn   = document.getElementById('ret_iva_sw')?.checked;
      const retRentaOn = document.getElementById('ret_renta_sw')?.checked;
      let retIvaMto    = retIvaOn   ? parseFloat(document.getElementById('ret_iva_mto')?.value || '0')   || 0 : 0;
      let retRentaMto  = retRentaOn ? parseFloat(document.getElementById('ret_renta_mto')?.value || '0') || 0 : 0;
      const totalPagar = total - retIvaMto - retRentaMto;

      if (totalPagar > THRESHOLD_MH && (!receptorSel || !receptorSel.value || isClientesVariosSelected())) {
        e.preventDefault();
        alert(`El total supera $${THRESHOLD_MH.toFixed(2)}.\nDebes seleccionar un cliente registrado (no "Clientes varios").`);
        receptorSel?.focus();
        return;
      }

      if (typeof enforceClienteRequirement === 'function') {
        enforceClienteRequirement(totalPagar);
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      if (submitBtn && submitBtn.disabled) {
        receptorSel?.focus();
        return;
      }
      // <<< Fin bloqueo MH
      setSubmitting(true);

      try {
        const fd = new FormData(form);
        // Idempotencia (el backend debe ignorar duplicados con misma key)
        fd.append('idempotency_key', `${Date.now()}-${Math.random().toString(36).slice(2)}`);

        const resp = await fetch(form.action || location.href, {
          method: 'POST',
          body: fd,
          headers: { 'X-Requested-With':'XMLHttpRequest' },
          credentials: 'same-origin'
        });

        const ct = resp.headers.get('content-type') || '';
        const isJson = ct.includes('application/json');
        const data = isJson ? await resp.json() : null;

        // 1) Éxito normal
        if (resp.ok && data && (data.ok || data.print_url || data.redirect)) {
          if (data.print_url && window.AndroidPrinter?.printFactura) {
            try { window.AndroidPrinter.printFactura(data.print_url); } catch(_e){}
          }
          if (data.redirect) { window.location.href = data.redirect; return; }
          setSubmitting(false); // dejamos habilitado el botón por si hace otra venta
          alert(data?.mensaje || 'Operación completada.');
          return;
        }

        // 2) Error controlado → Modal
        if (data && (data.mostrar_modal || data.puede_contingencia || data.mensaje)) {
          setSubmitting(false);
          showMhModal(data);
          return;
        }

        // 3) Error genérico (con/sin JSON)
        if (!resp.ok) {
          setSubmitting(false);
          alert((data && (data.error||data.mensaje)) || `Error al generar: HTTP ${resp.status}`);
          return;
        }

        // 4) Si no fue JSON (HTML), fallback a submit normal
        
      } catch (err) {
        console.error('Submit error:', err);
        setSubmitting(false);
        alert('Error de red, intenta de nuevo.');
      }
    });

    // Atajo F9 (respeta bloqueo)
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'F9') { e.preventDefault(); if (!SUBMITTING) form.requestSubmit(); }
    });

    // Sticky del precio si se edita manualmente
    priceInput?.addEventListener('input', ()=> priceInput.dataset.sticky = priceInput.value ? '1' : '');
  })();
</script>

{% if prefill_factura %}
<script>
  (function(){
    try{
      const PF = {{ prefill_factura|safe }};
      if(PF && PF.receptor_id){
        const sel = document.getElementById('receptor_id');
        if(sel){ sel.value = String(PF.receptor_id); sel.dispatchEvent(new Event('change')); }
      }
      if(PF && PF.items && PF.items.length){
        PF.items.forEach(it=>{
          window.POS.items.push({
            id: it.id, codigo: it.codigo, nombre: it.nombre,
            precio: parseFloat(it.precio||'0')||0,
            cantidad: parseInt(it.cantidad||'1',10),
            desc_pct: parseFloat(it.desc_pct||'0')||0,
            aplica_iva: !!it.iva_on, stock: null,
            stock: it.stock,
          });
        });
        if(typeof window.renderItems==='function') window.renderItems();
        if(typeof window.calcTotals==='function') window.calcTotals();
      }
    }catch(e){ console.error('prefill_cart error', e); }
  })();
</script>
{% endif %}



{% endblock %}
