{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4 px-4">

  <h2 class="mb-3">
    <i class="bi bi-layout-split text-warning"></i>
    Dividir Cuentas - Mesa {{ pedido.mesa.numero }}
  </h2>

  <!-- TABS CUENTAS -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    {% for cuenta in cuentas %}
      <div class="cuenta-tab active d-flex align-items-center gap-2 rounded p-2 bg-white border" 
            data-cuenta-id="{{ cuenta.id }}" 
            style="cursor: pointer; min-width: 150px;">
        
        <i class="bi bi-person text-primary"></i>
        
        <span class="flex-grow-1">{{ cuenta.nombre }}</span>
        
        <div class="d-flex gap-1 px-2">
          <i class="bi bi-pencil text-muted change-name-icon"
              style="cursor: pointer;"
              data-bs-toggle="modal"
              data-bs-target="#cambioNombreCuentaModal"
              data-cuenta-id="{{ cuenta.id }}"
              data-cuenta-nombre="{{ cuenta.nombre }}">
          </i>
  
          <i class="bi bi-x-lg delete-cuenta-icon"
              style="cursor: pointer;"
              data-bs-toggle="modal"
              data-bs-target="#EliminarCuentaModal"
              data-cuenta-id="{{ cuenta.id }}"
              data-cuenta-nombre="{{ cuenta.nombre }}">
          </i>
        </div>
  
        <span class="badge bg-secondary">$ {{ cuenta.total }}</span>
      </div>
    {% endfor %}
  
    <button class="btn btn-primary btn-sm d-flex align-items-center" id="btn-add-cuenta">
      <i class="bi bi-plus-lg me-1"></i> Nueva cuenta
    </button>
  </div>
  <!-- ðŸ”µ PRODUCTOS DISPONIBLES (POOL) -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light">
    <strong>Productos disponibles</strong>
  </div>

  <div class="list-group list-group-flush">
    {% for detalle in pool_detalles %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong>{{ detalle.platillo__nombre }}</strong>
        <small class="text-muted">$ {{ detalle.precio_unitario }}</small>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span class="fw-bold me-2">
          disp: {{ detalle.cantidad }}
        </span>

        <!-- selector de cuenta -->
        <select class="form-select form-select-sm cuenta-destino" required>
          {% for cuenta in cuentas %}
            {% if cuenta.estado == "ABIERTA" %}
              <option value="{{ cuenta.id }}"
                {% if forloop.first %}selected{% endif %}>
                {{ cuenta.nombre }}
              </option>
            {% endif %}
          {% endfor %}
        </select>
        

        <!-- botÃ³n agregar -->
        <button class="btn btn-sm btn-outline-primary btn-add-from-pool"
                data-platillo-id="{{ detalle.platillo_id }}">
          <i class="bi bi-plus"></i>
        </button>
      </div>

    </div>
    {% empty %}
    <div class="list-group-item text-muted">
      No hay productos disponibles
    </div>
    {% endfor %}
  </div>
</div>


  {% for cuenta in cuentas %}
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between">
      <div>
        <strong>{{ cuenta.nombre }}</strong>
        <span class="badge bg-info ms-2">{{ cuenta.estado }}</span>
      </div>
      <div class="fw-bold">
        Total: ${{ cuenta.total }}
      </div>
    </div>

    <div class="list-group list-group-flush">

      {% for detalle in cuenta.detalles.all %}
      <div class="list-group-item d-flex justify-content-between align-items-center"
           data-detalle-id="{{ detalle.id }}">
        <div>
          {{ detalle.platillo.nombre }}
          <small class="text-muted">$ {{ detalle.precio_unitario }}</small>
        </div>

        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-sm btn-outline-secondary btn-minus"
                  data-detalle-id="{{ detalle.id }}">
            <i class="bi bi-dash"></i>
          </button>

          <span class="fw-bold">
            act: {{ detalle.cantidad }}
          </span>

          <button class="btn btn-sm btn-outline-primary btn-plus"
                  data-platillo-id="{{ detalle.platillo_id }}"
                  data-cuenta-id="{{ cuenta.id }}">
            <i class="bi bi-plus"></i>
          </button>
        </div>
      </div>
      {% empty %}
      <div class="list-group-item text-muted">
        Sin productos en esta cuenta
      </div>
      {% endfor %}

    </div>

    <div class="card-footer">
      {% if cuenta.estado == "ABIERTA" %}
        <a href="#"
           onclick="cerrarCuenta(event, {{ cuenta.id }})"
           class="btn btn-secondary">
          <i class="bi bi-lock"></i> Cerrar cuenta
        </a>
      {% endif %}
    </div>
  </div>
  {% endfor %}

</div>


<!-- Modal para cambiar nombre -->
<div class="modal fade" id="cambioNombreCuentaModal" tabindex="-1" aria-labelledby="cambioNombreCuenta" aria-hidden="true" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="cambioNombreCuenta">Cambio nombre cuenta</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" id="cambio_nombre_cuenta_form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="name" class="col-form-label">Nombre</label>
            <input type="text" class="form-control" id="name" name="name">
          </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
    </div>
  </div>
</div>

<!-- Modal para eliminar cuenta -->
<div class="modal fade" id="EliminarCuentaModal" tabindex="-1" aria-labelledby="eliminarCuenta" aria-hidden="true" >
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="eliminarCuenta">Eliminar</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="post" id="eliminar_cuenta_form">
          {% csrf_token %}
          <p>Â¿Estas seguro de eliminar la cuenta "<strong id="nombre-cuenta-a-eliminar"></strong>"?</p>
      
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary">Eliminar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<script>
  function getCookie(name) {
    let v = null;
    document.cookie.split(";").forEach(c => {
      c = c.trim();
      if (c.startsWith(name + "=")) {
        v = decodeURIComponent(c.substring(name.length + 1));
      }
    });
    return v;
  }
  
  /* âž• tomar 1 unidad del POOL */
  document.querySelectorAll(".btn-plus").forEach(btn => {
    btn.addEventListener("click", async () => {
      const platilloId = btn.dataset.platilloId;
      const cuentaId = btn.dataset.cuentaId;
  
      const resp = await fetch("{% url 'mover_detalle' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
          platillo_id: platilloId,
          cuenta_id: cuentaId,
          delta: 1
        })
      });
  
      if (!resp.ok) {
        alert("No hay unidades disponibles");
        return;
      }
  
      location.reload();
    });
  });
  
  /* âž– devolver 1 unidad al POOL */
  document.querySelectorAll(".btn-minus").forEach(btn => {
    btn.addEventListener("click", async () => {
      const detalleId = btn.dataset.detalleId;
  
      const resp = await fetch("{% url 'mover_detalle' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
          detalle_id: detalleId,
          delta: -1
        })
      });
  
      if (!resp.ok) {
        alert("Error al devolver");
        return;
      }
  
      location.reload();
    });
  });
  
  /* âž• nueva cuenta */
  document.getElementById("btn-add-cuenta").onclick = async () => {
    const resp = await fetch("{% url 'crear-cuenta-extra' pedido.id %}", {
      method: "POST",
      headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
    if (resp.ok) location.reload();
    else alert("No se pudo crear la cuenta");
  };
  
  /* ðŸ”’ cerrar cuenta */
  async function cerrarCuenta(e, cuentaId) {
    e.preventDefault();
    const resp = await fetch(
      `{% url 'cambiar-estado-cuenta' 0 'CERRADA' %}`.replace("/0/", `/${cuentaId}/`),
      {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") }
      }
    );
  
    if (resp.ok) location.reload();
    else alert("No se pudo cerrar la cuenta");
  }
  </script>

  <script>
    /* âž• agregar desde POOL a cuenta seleccionada */
    document.querySelectorAll(".btn-add-from-pool").forEach(btn => {
      btn.addEventListener("click", async () => {
    
        const platilloId = btn.dataset.platilloId;   // âœ… AQUÃ
        const select = btn.closest(".list-group-item")
                          .querySelector(".cuenta-destino");
        const cuentaId = select.value;
    
        console.log("platilloId", platilloId); // "20"
        console.log("cuentaId", cuentaId);     // "83"
    
        if (!platilloId || !cuentaId) {
          alert("Datos incompletos");
          return;
        }
    
        const resp = await fetch("{% url 'mover_detalle' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken")
          },
          body: JSON.stringify({
            platillo_id: platilloId,
            cuenta_id: cuentaId,
            delta: 1
          })
        });
    
        if (!resp.ok) {
          const data = await resp.json();
          alert(data.error || "Error");
          return;
        }
    
        location.reload();
      });
    });
    
    


    document.querySelectorAll(".change-name-icon").forEach(icon => {
      icon.addEventListener("click", () => {
        const cuentaId = icon.dataset.cuentaId;
        const nombre = icon.dataset.cuentaNombre;

        const form = document.getElementById("cambio_nombre_cuenta_form");
        form.action = "{% url 'cambio_nombre_cuenta' 0 %}".replace("0", cuentaId);

        document.getElementById("name").value = nombre;
      });
    });

    document.querySelectorAll(".delete-cuenta-icon").forEach(icon => {
      console.log("print")
      icon.addEventListener("click", () => {
        const cuentaId = icon.dataset.cuentaId;
        const nombre = icon.dataset.cuentaNombre;
        const span_nombre = document.getElementById("nombre-cuenta-a-eliminar")
        const form = document.getElementById("eliminar_cuenta_form");
        console.log("form ", form)
        console.log("nombre ", nombre)

        span_nombre.textContent = nombre
        
        form.action = "{% url 'eliminar_cuenta_extra' 0 %}".replace("0", cuentaId);

      });
    });

    </script>
    
  
  {% endblock %}
  