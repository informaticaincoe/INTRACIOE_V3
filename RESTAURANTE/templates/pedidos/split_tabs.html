  {% extends "base.html" %}
  {% block content %}

  <style>
    .disable-row {
      background-color: #00000010;
    } /* Cerrar correctamente */

    .disable {
      background-color: #00000010!important;
      border: #00000041!important;
      color: #00000081!important;
      opacity: 0.5; /* Opcional: para que se vea visualmente desactivado */
      pointer-events: none; /* Evita clics si no usas el atributo disabled */
    }

    .cerrado {
      background-color: #0000000d!important;
      border: #00000041!important;
      color: #000000b5!important;
      opacity: 0.5; /* Opcional: para que se vea visualmente desactivado */
      pointer-events: none; /* Evita clics si no usas el atributo disabled */
    }
    
    .display-none {
      display: none;
    }
  </style>

  <div class="container-fluid mt-4 px-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="text-black">
        <i class="bi bi-layout-split me-2 text-warning"></i>
        Dividir Cuentas - Mesa {{ pedido.mesa.numero }}
      </h2>
    </div>

    <!-- TABS DE CUENTAS -->
    <ul class="nav nav-tabs" id="cuentasTabs">
      <li class="nav-item">
        <button class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#tab-pedido"
                data-cuenta-id="POOL"
                type="button">
          <i class="bi bi-receipt me-1"></i> Pedido
        </button>
      </li>

      {% for c in cuentas %}
      <li class="nav-item">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#tab-cuenta-{{ c.id }}"
                data-cuenta-id="{{ c.id }}"
                data-estado="{{ c.estado }}"
                type="button">
          <i class="bi bi-person me-1"></i> {{ c.nombre }}
          <span class="badge bg-secondary ms-2">$ {{ c.total }}</span>
        </button>
      </li>
      {% endfor %}
      <li>
        <div class="mt-3 text-center">
          <button id="btn-nueva-cuenta" class="btn btn-outline-secondary" type="button">
            <i class="bi bi-plus-circle me-2"></i>
            Añadir otra cuenta
          </button>
        </div>
      </li>
    </ul>
    

    <!-- CONTENIDO DE LOS TABS -->
    <div class="tab-content border border-top-0 p-3 bg-white">

      <!-- TAB PEDIDO -->
      <div class="tab-pane fade show active" id="tab-pedido">
        <h5>Resumen del pedido</h5>
        <table class="table">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cant.</th>
              <th>Precio</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            <tr>
              <td>{{ it.platillo.nombre }}</td>
              <td>{{ it.cantidad }}</td>
              <td>${{ it.precio }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- TABS DE CUENTAS -->
      {% for c in cuentas %}
      <div class="tab-pane fade" id="tab-cuenta-{{ c.id }}">
        <div class="d-flex justify-content-between mb-3">
          <div>
            <h5>{{ c.nombre }}</h5>
            <span class="badge bg-info">{{ c.estado }}</span>
          </div>
          <div class="fw-bold fs-5">
            Total: ${{ c.total }}
          </div>
        </div>

        <div class="list-group list-group-flush">
          {% for it in items %}
          <div class="list-group-item d-flex justify-content-between align-items-center" data-platillo-id="{{ it.platillo.id }}">
            <div>{{ it.platillo.nombre }} <small>${{ it.precio }}</small></div>
            <div class="d-flex gap-2 align-items-center">
              <button class="btn btn-sm btn-outline-primary btn-minus" data-map="{{ it.map_json|escape }}">
                <i class="bi bi-dash"></i>
              </button>
              <span class="qty-badge" data-map="{{ it.map_json|escape }}">0 / 0</span>
              <button class="btn btn-sm btn-outline-primary btn-plus" data-map="{{ it.map_json|escape }}">
                <i class="bi bi-plus"></i>
              </button>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="mt-2">
          <a href="{% url 'cuenta-facturar' c.id %}" class="btn btn-success btn-sm {% if c.estado == "ABIERTA" %}disable {% endif %}">Facturar</a>
          {% if c.estado == "ABIERTA" %}
            <a href="#" onclick="cambiarEstado(event, {{ c.id }}, 'CERRADA')" class="btn btn-secondary">
              <i class="bi bi-lock"></i> Cerrar cuenta
            </a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    
      <!-- TABS DE CUENTAS -->
      {% for c in cuentas %}
        <div class="tab-pane fade" id="tab-cuenta-{{ c.id }}">
    
          <div class="d-flex justify-content-between mb-3">
            <div>
              <h5>{{ c.nombre }}</h5>
              <span class="badge bg-info text-dark">{{ c.estado }}</span>
            </div>
            <div class="fw-bold fs-5">
              Total: ${{ c.total }}
            </div>
          </div>
          
          <div class="mb-3">
            <a href="{% url 'cuenta-facturar' c.id %}"
              class="btn btn-success btn-sm btn-facturar">
              <i class="bi bi-receipt"></i> Facturar
            </a>
          </div>
    
        </div>
      {% endfor %}
      
    </div>  
    
    <!-- PRODUCTOS -->
    <div class="card shadow mt-4 cuentas-separadas d-none">
      <div class="card-header">
        <b>Asignar productos a la cuenta</b>
      </div>
    
      <div class="list-group list-group-flush">
        {% for it in items %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
    
            <div>
              <div class="fw-bold">{{ it.platillo.nombre }}</div>
              <small class="text-muted">Precio: ${{ it.precio }}</small>
            </div>
    
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-primary btn-sm btn-minus"
                      data-map="{{ it.map_json|escape }}">
                <i class="bi bi-dash"></i>
              </button>
    
              <span class="qty-badge"
                    data-map="{{ it.map_json|escape }}">
                0 / 0
              </span>
    
              <button class="btn btn-outline-primary btn-sm btn-plus"
                      data-map="{{ it.map_json|escape }}">
                <i class="bi bi-plus"></i>
              </button>
            </div>
    
          </div>
        {% endfor %}
      </div>
    </div>
    
    <script>
      function getCookie(name) {
        let cookieValue = null;
        document.cookie.split(";").forEach(c => {
          c = c.trim();
          if (c.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(c.substring(name.length + 1));
          }
        });
        return cookieValue;
      }

      function applyServerMapToAllRows(platilloId, newMap) {
        const rows = document.querySelectorAll(`[data-platillo-id="${platilloId}"]`);
        rows.forEach(row => applyServerMap(row, newMap));
      }

      
      document.getElementById("btn-nueva-cuenta").onclick = async () => {
        const resp = await fetch("{% url 'crear-cuenta-extra' pedido.id %}", {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken") }
        });
        if (resp.ok) location.reload();
        else alert("No se pudo crear la cuenta");
      };
    
    
      // Cuenta activa (inicia con la primera cuenta si quieres)
      let activeCuentaId = "{{ cuentas.0.id }}";
    
      function safeParseMap(s) {
        try { return JSON.parse(s); } catch { return {}; }
      }
    
      function refreshQtyBadges() {
        const activeTabBtn = document.querySelector(`#cuentasTabs button[data-cuenta-id="${activeCuentaId}"]`);
        const esCerrada = activeTabBtn ? activeTabBtn.dataset.estado === "CERRADA" : false;
    
        const pane = document.querySelector(".tab-pane.active");
        const itemsProductos = pane ? pane.querySelectorAll(".list-group-item") : [];

    
        itemsProductos.forEach(row => {
          const badge = row.querySelector(".qty-badge");
          if (!badge) return;
      
          const map = safeParseMap(badge.dataset.map);
      
          const enActiva = map[activeCuentaId]?.qty || 0;
          const disp = map["POOL"]?.qty || 0;
      
          badge.textContent = `act: ${enActiva} / disp: ${disp}`;
      
          const btnPlus = row.querySelector(".btn-plus");
          const btnMinus = row.querySelector(".btn-minus");
      
          btnPlus.disabled = disp <= 0;
          btnMinus.disabled = enActiva <= 0;
      
          row.classList.toggle("disable-row", false);
          btnPlus.classList.toggle("disable", btnPlus.disabled);
          btnMinus.classList.toggle("disable", btnMinus.disabled);
        });    
      }
    
      function applyServerMap(containerEl, newMap) {
        const mapStr = JSON.stringify(newMap || {});
        const badge = containerEl.querySelector(".qty-badge");
        const btnPlus = containerEl.querySelector(".btn-plus");
        const btnMinus = containerEl.querySelector(".btn-minus");
    
        if (badge) badge.dataset.map = mapStr;
        if (btnPlus) btnPlus.dataset.map = mapStr;
        if (btnMinus) btnMinus.dataset.map = mapStr;
      }
    
      async function mover(detalleId, cuentaDestinoId, qty) {
        const fd = new FormData();
        fd.append("detalle_id", detalleId);
        fd.append("cuenta_destino_id", cuentaDestinoId);
        fd.append("qty", qty);
    
        const resp = await fetch("{% url 'detalle-mover-a-cuenta' %}", {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken") },
          body: fd
        });
    
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || "Error moviendo detalle");
        return data;
      }
    
      function bindControls() {
        document.querySelectorAll(".btn-plus").forEach(btn => {
          btn.onclick = async () => {
            const row = btn.closest(".list-group-item");
            const platilloId = row.dataset.platilloId;
        
            const badge = row.querySelector(".qty-badge");
            const map = safeParseMap(badge.dataset.map);
        
            const detalleId = map["POOL"]?.detalle_id;
            if (!detalleId) return alert("No hay detalle en POOL para mover.");
        
            try {
              btn.disabled = true;
              const data = await mover(detalleId, activeCuentaId, 1);
        
              // ✅ actualizar TODAS las filas del platillo en TODOS los tabs
              applyServerMapToAllRows(platilloId, data.map);
        
              refreshQtyBadges();
            } catch (e) {
              alert(e.message || "Error");
            } finally {
              btn.disabled = false;
            }
          };
        });
        
        document.querySelectorAll(".btn-minus").forEach(btn => {
          btn.onclick = async () => {
            const row = btn.closest(".list-group-item");
            const platilloId = row.dataset.platilloId;
        
            const badge = row.querySelector(".qty-badge");
            const map = safeParseMap(badge.dataset.map);
        
            const detalleId = map[activeCuentaId]?.detalle_id;
            if (!detalleId) return alert("No hay detalle en esta cuenta para devolver.");
        
            try {
              btn.disabled = true;
              const data = await mover(detalleId, "POOL", 1);
        
              // ✅ actualizar TODAS las filas del platillo en TODOS los tabs
              applyServerMapToAllRows(platilloId, data.map);
        
              refreshQtyBadges();
            } catch (e) {
              alert(e.message || "Error");
            } finally {
              btn.disabled = false;
            }
          };
        });
      }
    
      document.addEventListener("DOMContentLoaded", () => {
        refreshQtyBadges();
        bindControls();
      });
    
      // Cambio de pestaña
      document.querySelectorAll("#cuentasTabs button").forEach(btn => {
        btn.addEventListener("shown.bs.tab", e => {
          activeCuentaId = e.target.dataset.cuentaId;
          refreshQtyBadges();
        });
      });    

      // Cambiar estado a cerrado de una cuenta
      async function cambiarEstado(event, cuentaId, estado) {
        event.preventDefault();
      
        const url = `{% url 'cambiar-estado-cuenta' 0 'CERRADA' %}`.replace("/0/", `/${cuentaId}/`).replace("/CERRADA/", `/${estado}/`);
      
        const resp = await fetch(url, {
          method: "POST",
          headers: { "X-CSRFToken": getCookie("csrftoken") }
        });
      
        const data = await resp.json().catch(() => ({}));
        if (resp.ok && data.ok) {
          location.reload();
        } else {
          alert(data.error || "Error al cambiar el estado");
        }
      }
      
    </script>
  {% endblock %}