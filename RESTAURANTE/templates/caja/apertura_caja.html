{% extends "base.html" %}
{% load l10n %}
{% block title %}Apertura de caja{% endblock %}

{% block content %}
<div class="container mt-3">
  <h5 class="h5 mb-3 text-gray-800">Apertura de caja</h5>

  <form method="post" class="border border-secondary border-opacity-10 px-3 py-4 rounded">
    {% csrf_token %}

    <div class="mb-3">
      <label for="monto_inicial" class="form-label">Efectivo de apertura (total)</label>
      <input id="monto_inicial" name="monto_inicial" type="number" step="0.01" min="0" class="form-control" disabled required>
    </div>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Denominación</th>
            <th style="width: 180px;">Cantidad</th>
            <th class="text-end">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for den in denominaciones %}
          <tr data-valor="{{ den.valor|unlocalize }}">
            <td>{{ den.nombre }} ({{ den.valor }})</td>
            <td>
              <input type="number" min="0" step="1" class="form-control form-control-sm qty" name="den_{{ den.id }}" value="0">
            </td>
            <td class="text-end subtotal">$0.00</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="text-end">Total desglose</th>
            <th class="text-end" id="total_desglose">$0.00</th>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <a href="{% url 'caja' %}" class="btn btn-secondary">Cancelar</a>
      <button type="submit" class="btn btn-primary">Abrir caja</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const totalDesgloseElement = document.getElementById("total_desglose");
    const montoInicialInput = document.getElementById("monto_inicial");

    document.addEventListener("input", function(e) {
        // Solo actuar si el cambio fue en un input de cantidad (qty)
        if (!e.target.classList.contains("qty")) return;

        let total = 0;
        
        // Recorrer cada fila para calcular subtotales y el gran total
        document.querySelectorAll("tr[data-valor]").forEach(tr => {
            // Reemplazamos coma por punto por si acaso la localización falla
            const valorStr = tr.getAttribute("data-valor").replace(',', '.');
            const valor = parseFloat(valorStr) || 0;
            const qty = parseInt(tr.querySelector(".qty").value) || 0;
            
            const sub = valor * qty;
            total += sub;
            
            // Actualizar el texto del subtotal en la fila
            tr.querySelector(".subtotal").textContent = "$" + sub.toFixed(2);
        });

        // 1. Actualizar el texto del total en el pie de tabla
        totalDesgloseElement.textContent = "$" + total.toFixed(2);

        // 2. Sincronizar automáticamente con el campo de Monto Inicial
        // Usamos toFixed(2) para que el input reconozca el formato de moneda correctamente
        montoInicialInput.value = total.toFixed(2);
    });
});
</script>
{% endblock %}