{# templates/caja/dashboard_caja.html #}
{% extends "base.html" %}
{% load l10n %}
{% block title %}Dashboard Caja{% endblock %}

{% block content %}
<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h5 class="mb-0 text-gray-800">Caja abierta</h5>
        <small class="text-muted">
        Caja #{{ caja.id }} • Apertura: {{ caja.fecha_apertura|date:"d/m/Y H:i" }}
        </small>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'caja' %}" class="btn btn-outline-secondary btn-sm">Apertura</a>
        {# aquí luego pones el cierre #}
        <a href="{% url 'cierre-caja' %}" class="btn btn-danger btn-sm">Cerrar caja</a>
    </div>
    </div>

    <div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="text-muted">Monto inicial</div>
                <div class="fs-5 fw-semibold">${{ caja.monto_inicial|floatformat:2 }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="text-muted">Efectivo registrado</div>
                <div class="fs-5 fw-semibold">${{ caja.total_efectivo|floatformat:2 }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="text-muted">Ingresos / Retiros</div>
          <div class="fs-6">
            <div>+ ${{ tot_ingresos|floatformat:2 }}</div>
            <div>- ${{ tot_retiros|floatformat:2 }}</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="text-muted">Esperado en caja</div>
          <div class="fs-5 fw-semibold">${{ esperado|floatformat:2 }}</div>
          <small class="text-muted">Inicial + efectivo + ingresos - retiros</small>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-5">
      <div class="card">
        <div class="card-header">
          Registrar movimiento
        </div>
        <div class="card-body">
          <form method="post" action="{% url 'caja-movimiento' %}">
            {% csrf_token %}
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Tipo</label>
                <select class="form-select" name="tipo_movimiento" required>
                  <option value="INGRESO">Ingreso</option>
                  <option value="RETIRO">Retiro</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Categoría</label>
                <select class="form-select" name="categoria">
                  <option value="OTROS">Otros</option>
                  <option value="PROVEEDOR">Pago a Proveedor</option>
                  <option value="COMPRA_LOCAL">Compra Insumos</option>
                  <option value="NOMINA">Adelanto Sueldo</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Monto</label>
                <input type="number" step="0.01" min="0.01" class="form-control" name="monto" required>
              </div>
              <div class="col-md-12">
                <label class="form-label">Motivo</label>
                <input type="text" class="form-control" name="motivo" maxlength="200" required>
              </div>
            </div>
            <div class="mt-3 d-flex justify-content-end">
              <button class="btn btn-primary">Guardar</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-header">Arqueo de apertura</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Denominación</th>
                  <th class="text-end">Cantidad</th>
                  <th class="text-end">Subtotal</th>
                </tr>
              </thead>
              <tbody>
                {% for d in detalle_apertura %}
                <tr>
                  <td>{{ d.denominacion.nombre }} ({{ d.denominacion.valor }})</td>
                  <td class="text-end">{{ d.cantidad }}</td>
                  <td class="text-end">
                    ${{ d.denominacion.valor|floatformat:2 }} × {{ d.cantidad }} =
                    ${{ d.subtotal|floatformat:2 }}
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted py-3">Sin detalle de apertura.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <div class="col-lg-7">
      <div class="card">
        <div class="card-header">Movimientos recientes</div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Categoría</th>
                  <th>Motivo</th>
                  <th class="text-end">Monto</th>
                </tr>
              </thead>
              <tbody>
                {% for m in movimientos %}
                <tr>
                  <td>{{ m.fecha|date:"d/m/Y H:i" }}</td>
                  <td>
                    {% if m.tipo_movimiento == "INGRESO" %}
                      <span class="badge bg-success">Ingreso</span>
                    {% else %}
                      <span class="badge bg-danger">Retiro</span>
                    {% endif %}
                  </td>
                  <td>{{ m.get_categoria_display }}</td>
                  <td>{{ m.motivo }}</td>
                  <td class="text-end">${{ m.monto|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-3">Sin movimientos.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalPedidosPendientes" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content ">
        <div class="modal-header bg-light">
          <h5 class="modal-title text-danger">
              <i class="bi bi-exclamation-triangle-fill"></i> Acción Denegada
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center py-4">
          {% for message in messages %}
            {% if "cierre_pedidos_pendientes" in message.tags %}
              <p class="fs-5">{{ message }}</p>
            {% endif %}
          {% endfor %}
          <p class="text-muted small">Por favor, cierre o cancele todos los pedidos de las mesas antes de proceder al cierre de caja.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendido</button>
          <a href="{% url 'mesas-lista' %}" class="btn btn-primary">Ir a Mesas</a>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    {% if messages %}
      {% for message in messages %}
        {% if "cierre_pedidos_pendientes" in message.tags %}
          var myModal = new bootstrap.Modal(document.getElementById('modalPedidosPendientes'));
          myModal.show();
        {% endif %}
      {% endfor %}
    {% endif %}
  });
</script>
{% endblock %}
