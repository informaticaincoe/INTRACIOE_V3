{% extends "base.html" %}
{% block title %}Comanda · Cocina{% endblock %}

{% block content %}
<div class="container-fluid mt-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Comandas en cocina</h5>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'comanda-cocina' %}">Refrescar</a>
  </div>

  {% if comandas %}
    <div class="row g-3">
      {% for c in comandas %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card shadow-sm">

            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                  <div class="fw-bold">Mesa #{{ c.pedido.mesa.numero }} · Comanda #{{ c.numero }}</div>
                  <span class="badge {% if c.estado == 'ENVIADA' %} bg-primary {% elif c.estado == 'EN_PREPARACION' %} bg-warning text-dark {% elif c.estado == 'LISTA' %} bg-success {% endif %}">
                      {{ c.get_estado_display }}
                  </span>
              </div>
          
              <div>
                  {% if user.role == "cocinero" %}
                    {% if c.estado == 'ENVIADA' %}
                        <button class="btn btn-sm btn-primary btn-accion" 
                                data-id="{{ c.id }}" 
                                data-url="{% url 'comanda-item-preparacion' id=c.id %}">
                            Iniciar pedido
                        </button>
                    {% elif c.estado == 'EN_PREPARACION' %}
                        <button class="btn btn-sm btn-success btn-accion" 
                                data-id="{{ c.id }}" 
                                data-url="{% url 'comanda-item-listo' id=c.id %}">
                            Finalizar
                        </button>
                    {% endif %}
                  {% endif %}
              </div>
          </div>

            <div class="card-body p-0">
              <ul class="list-group list-group-flush">
                {% for it in c.items.all %}
                  {% if it.estado != "ENTREGADO" and it.estado != "CANCELADO" %}
                  <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-2">
                      <div class="fw-semibold">{{ it.cantidad }} × {{ it.nombre }}</div>
                      {% if it.notas %}
                        <div class="text-muted small">Nota: {{ it.notas }}</div>
                      {% endif %}
                      <div class="text-muted small">Estado: {{ it.get_estado_display }}</div>
                    </div>
                  </li>
                  {% endif %}
                {% empty %}
                  <li class="list-group-item text-muted">Sin items</li>
                {% endfor %}
              </ul>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No hay comandas pendientes.</div>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      // Seleccionamos todos los botones con la clase btn-accion
      const botones = document.querySelectorAll(".btn-accion");
  
      botones.forEach(btn => {
          btn.addEventListener("click", function() {
              const urlDestino = this.dataset.url; // Obtenemos la URL del atributo data-url
              
              // Feedback visual: deshabilitar para evitar doble click
              btn.disabled = true;
              const textoOriginal = btn.innerHTML;
              btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>...';
  
              fetch(urlDestino, {
                  method: "POST",
                  headers: {
                      "X-Requested-With": "XMLHttpRequest",
                      "X-CSRFToken": "{{ csrf_token }}"
                  }
              })
              .then(res => {
                  if (!res.ok) throw new Error('Error en el servidor');
                  return res.json();
              })
              .then(data => {
                  if (data.ok) {
                      // Refrescamos la página para mostrar los nuevos estados y colores
                      location.reload();
                  } else {
                      alert("No se pudo actualizar: " + (data.error || "error desconocido"));
                      btn.disabled = false;
                      btn.innerHTML = textoOriginal;
                  }
              })
              .catch(err => {
                  console.error("Error:", err);
                  alert("Error de conexión en comanda.html");
                  btn.disabled = false;
                  btn.innerHTML = textoOriginal;
              });
          });
      });
  });
  (function () {
    const protocol = (window.location.protocol === "https:") ? "wss" : "ws";
    const wsUrl = `${protocol}://${window.location.host}/ws/cocina/comandas/`;
    const socket = new WebSocket(wsUrl);
  
    socket.onopen = () => console.log("✅ WS conectado", wsUrl);
    socket.onerror = (e) => console.error("❌ WS error", e);
    socket.onclose = (e) => console.warn("⚠️ WS cerrado", e.code, e.reason);
  
    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === "comanda_created") {
        location.reload();
      }
    };
  })();
</script>
{% endblock %}
