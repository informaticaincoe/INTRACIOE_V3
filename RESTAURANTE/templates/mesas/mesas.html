{% extends 'base.html' %} 
{% block title %} Mesas {% endblock %} 
{% block content %}
<style>
  /* layout general */
.mesa-box { cursor: pointer; }
.mesa-card{
  width: 100%;
  height: 8.5rem;
  border-radius: 5px;
  background: #fff;
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  position: relative;
}
/* .mesa-card:hover{
  transform: translateY(-2px);
  box-shadow: 0 .75rem 1.5rem rgba(0,0,0,.08) !important;
} */

/* dropdown icon */
.mesa-actions{
  position:absolute; top:.4rem; right:.4rem;
  opacity:.7;
}

.mesa-card:hover .mesa-actions{ opacity: 1; }

/* Colores según el estado */
  .is-libre { 
    border-color: rgba(0,0,0,.12) !important; 
  }
  
  .is-sinmesero { 
    border-color: #474747 !important;
    border-style: dashed !important; /* Opcional: borde punteado para destacar que falta algo */
  }

  .is-pendiente-orden { 
    border-color: rgb(244, 178, 93) !important; 
    background-color: rgba(244, 178, 93, 0.05); 
  }

  .is-ocupada { 
    border-color: rgb(34, 197, 94) !important; 
    background-color: rgba(34, 197, 94, 0.05);
  }

  .is-entregado { 
    border-color:  rgb(13, 148, 136) !important; 
    background-color: rgba(13, 148, 136, 0.05);
  }

  .is-pendiente-pago { 
    border-color: rgb(16, 60, 191) !important; 
    background-color: rgba(16, 60, 191, 0.05);
  } 

/* Alerta cuando NO hay mesero asignado */
.sin-mesero {
    position: relative;
    animation: pulse-red 2s infinite;
    box-shadow: 0 0 10px rgba(220, 53, 69, 0.2);
}

/* círculo estado */
.mesa-status-circle{
  width: 3.2rem;
  aspect-ratio: 1 / 1;
  border-radius: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
}
.mesa-status-circle i{ line-height: 1; font-size: 1.6rem; }


/* etiqueta estado */
.mesa-pill{
  font-size:.85rem;
  border-radius: 999px;
  padding: .25rem .75rem;
  border: 1px solid transparent;
}

/* header inferior con número */
.mesa-num{
  font-weight: 600;
  font-size: 1rem;
  color: rgba(0,0,0,.75);
}

/* VIP tag */
.vip-tag{
  position:absolute;
  top:.55rem;
  left:.55rem;
  background:#ffc107;
  color:#212529;
  font-weight:700;
  font-size:.75rem;
  border-radius:999px;
  padding:.2rem .55rem;
  z-index: 2;
  box-shadow: 0 2px 8px rgba(0,0,0,.10);
}

</style>

<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="h5 mb-0 text-gray-800">Mesas</h5>
    <div>
      <a
        href="{% url 'crear-mesa' %}"
        class="btn btn-primary"
      >
        <i class="bi bi-plus-circle me-2"></i>Agregar mesa
      </a>
    </div>
  </div>

  <div class="mb-4">
    <form
      method="GET"
      action="{% url 'mesas-lista' %}"
      class="row g-3 align-items-center"
    >
      <div class="col-md-8 position-relative">
        <input
          type="text"
          class="form-control"
          id="id_search_name"
          name="search_name"
          placeholder="Buscar por nombre..."
          value="{{ request.GET.search_name|default:'' }}"
        />
        <i
          class="bi bi-x-lg position-absolute top-50 translate-middle-y end-0 me-3 clear-icon"
          data-target="id_search_name"
          style="display: none"
        ></i>
      </div>
    </form>
  </div>

  <div class="container">
    <div class="row g-5">
      {% for mesa in lista_mesas %}
        {% include "mesas/_mesa_card.html" with mesa=mesa acciones=mesa.acciones %}
      {% empty %}
        <div class="col-12">
          <p class="opacity-50 mb-0">No se ha encontrado ninguna mesa</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Modal (solo una vez, fuera del for) -->
  <div
    class="modal fade"
    id="eliminarMesaModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Eliminar mesa</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <form
          method="post"
          id="eliminarMesaForm"
        >
          {% csrf_token %}
          <div class="modal-body">
            <p>
              ¿Seguro que quieres eliminar la mesa "<strong
                id="nombre_mesa_eliminar"
              ></strong
              >"?
            </p>
            <small class="text-muted">Esta acción no se puede deshacer.</small>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-danger"
            >
              Eliminar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% include "pedidos/_toma_pedido.html" %}
{% include "asignacionMesas/asignar_modal.html" %}
{% include "pedidos/_ver_pedido.html" %}
{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modalEl = document.getElementById("asignarMeseroModal");
    if (!modalEl) return;
  
    modalEl.addEventListener("show.bs.modal", function (event) {
      const btn = event.relatedTarget;
      if (!btn) return;
  
      const mesaId = btn.getAttribute("data-mesa-id");
      const mesaNumero = btn.getAttribute("data-mesa-numero");

      console.log("Mesa numero", mesaNumero)
  
      document.getElementById("asignar_mesa_id").value = mesaId || "";
      document.getElementById("asignar_mesa_numero").textContent = mesaNumero || "—";
  
      // limpiar selección / campos
      const sel = document.getElementById("asignar_mesero_id");
      const chk = document.getElementById("asignar_es_fija");
      const fin = document.getElementById("asignar_fecha_fin");
      if (sel) sel.value = "";
      if (chk) chk.checked = false;
      if (fin) fin.value = "";
    });

    // --- Lógica del botón de limpieza del input ---
    const inputField = document.getElementById("id_search_name");
    const clearIcon = document.querySelector(
      '.clear-icon[data-target="id_search_name"]'
    );

    if (inputField && clearIcon) {
      const toggleClearIcon = () => {
        clearIcon.style.display =
          inputField.value.length > 0 ? "block" : "none";
      };

      toggleClearIcon();
      inputField.addEventListener("input", toggleClearIcon);

      clearIcon.addEventListener("click", () => {
        inputField.value = "";
        toggleClearIcon();
        inputField.focus();
        // Si quieres auto-buscar al limpiar:
        // inputField.closest('form').submit();
      });
    }

    // --- Modal eliminar mesa ---
    const eliminarMesaModal = document.getElementById("eliminarMesaModal");
    if (eliminarMesaModal) {
      eliminarMesaModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        if (!button) return;

        const mesasId = button.getAttribute("data-id");
        const mesasNombre = button.getAttribute("data-nombre");

        const nombreEl = document.getElementById("nombre_mesa_eliminar");
        const form = document.getElementById("eliminarMesaForm");

        if (nombreEl) nombreEl.textContent = mesasNombre || "";
        if (form && mesasId) {
          form.action = "{% url 'eliminar-mesa' 0 %}".replace(
            "/0/",
            "/" + mesasId + "/"
          );
        }
      });
    }
  });
</script>
{% endblock extra_js %}
{% endblock content %} 
