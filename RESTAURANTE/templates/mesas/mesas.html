{% extends 'base.html' %} 
{% block title %} Mesas {% endblock %} 
{% block content %}
<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h5 class="h5 mb-0 text-gray-800">Mesas</h5>
    <div>
      <a
        href="{% url 'crear-mesa' %}"
        class="btn btn-primary"
      >
        <i class="bi bi-plus-circle me-2"></i>Agregar mesa
      </a>
    </div>
  </div>

  <div class="mb-4">
    <form
      method="GET"
      action="{% url 'mesas-lista' %}"
      class="row g-3 align-items-center"
    >
      <div class="col-md-8 position-relative">
        <input
          type="text"
          class="form-control"
          id="id_search_name"
          name="search_name"
          placeholder="Buscar por nombre..."
          value="{{ request.GET.search_name|default:'' }}"
        />
        <i
          class="bi bi-x-lg position-absolute top-50 translate-middle-y end-0 me-3 clear-icon"
          data-target="id_search_name"
          style="display: none"
        ></i>
      </div>
    </form>
  </div>

  <div class="container">
    <div class="row g-5">
      {% for mesa in lista_mesas %}
      <div
        class="mesa-box col-12 col-md-4 col-lg-4 d-flex flex-column align-items-center gap-3"
      >
        <div
          class="shadow-sm p-3 border rounded-2 d-flex flex-column align-items-center justify-content-center gap-2 position-relative {% if mesa.estado == 'OCUPADA' %} border-warning {% endif %}"
          style="height: 8rem; width: 15rem"
        >
          <!-- Botón de eliminar (abre modal) -->
          {% if not mesa.tiene_mesero %}
          <div
            class="rounded-circle d-flex align-items-center justify-content-center"
            style="
              background-color: rgb(69, 69, 69);
              height: 3rem;
              width: 3rem;
            "
          >
            <i class="bi bi-exclamation text-white fs-3"></i>
            <a class="nav-link position-absolute top-0 end-0 pe-2" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#"><i class="bi bi-exclamation-triangle-fill text-warning text-center pe-2"></i>Asignar mesero</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#">Editar</a></li>
              <li><a class="dropdown-item" href="#">Eliminar</a></li>
            </ul>
          </div>
          <p
              class="fs-6 m-0 badge rounded-pill px-3 py-1 text-lowercase fw-normal"
              style="
                border: 1px rgb(69, 69, 69) solid;
                color: rgb(69, 69, 69);
              "
            >
              sin mesero asignado
            </p>
            <button
            type="button"
            class="btn btn-outline-dark btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#asignarMeseroModal"
            data-mesa-id="{{ mesa.id }}"
            data-mesa-numero="{{ mesa.numero }}"
          >
            Asignar mesero
          </button>
          
          {% elif mesa.estado == "OCUPADA"%}
            <div
              class="rounded-circle d-flex align-items-center justify-content-center"
              style="
                background-color: rgb(244, 178, 93);
                height: 3rem;
                width: 3rem;
              "
            >
              <i class="bi bi-fork-knife text-white fs-3"></i>
            </div>
            <p
              class="fs-6 m-0 badge rounded-pill px-3 py-1 text-lowercase fw-normal"
              style="
                border: 1px rgb(244, 178, 93) solid;
                color: rgb(244, 178, 93);
              "
            >
              {{ mesa.estado }}
            </p>
          {% endif %} 
          
          
        </div>

        <div class="p-0 m-0 text-center">
          <p class="m-0">{{ mesa.numero}}</p>
        </div>

        {% comment %}
        <button
          type="button"
          class="btn btn-outline-danger btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#eliminarMesaModal"
          data-id="{{ mesa.id }}"
          data-nombre="{{ mesa.numero }}"
        >
          Eliminar
        </button>
        {% endcomment %}
      </div>

      {% empty %}
      <div class="col-12">
        <p class="opacity-50 mb-0">No se ha encontrado ninguna mesa</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Modal (solo una vez, fuera del for) -->
  <div
    class="modal fade"
    id="eliminarMesaModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Eliminar mesa</h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <form
          method="post"
          id="eliminarMesaForm"
        >
          {% csrf_token %}
          <div class="modal-body">
            <p>
              ¿Seguro que quieres eliminar la mesa "<strong
                id="nombre_mesa_eliminar"
              ></strong
              >"?
            </p>
            <small class="text-muted">Esta acción no se puede deshacer.</small>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn btn-danger"
            >
              Eliminar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% include "asignacionMesas/asignar_modal.html" %}
{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modalEl = document.getElementById("asignarMeseroModal");
    console.log("MODAAAAl")
    if (!modalEl) return;
  
    modalEl.addEventListener("show.bs.modal", function (event) {
      const btn = event.relatedTarget;
      if (!btn) return;
  
      const mesaId = btn.getAttribute("data-mesa-id");
      const mesaNumero = btn.getAttribute("data-mesa-numero");

      console.log("Mesa numero", mesaNumero)
  
      document.getElementById("asignar_mesa_id").value = mesaId || "";
      document.getElementById("asignar_mesa_numero").textContent = mesaNumero || "—";
  
      // limpiar selección / campos
      const sel = document.getElementById("asignar_mesero_id");
      const chk = document.getElementById("asignar_es_fija");
      const fin = document.getElementById("asignar_fecha_fin");
      if (sel) sel.value = "";
      if (chk) chk.checked = false;
      if (fin) fin.value = "";
    });

    // --- Logica para clases segun el estado de la mesa --//
    const boxes = document.querySelectorAll(".mesa-box");

    const borderByEstado = {
      LIBRE: "border-success",
      OCUPADA: "border-warning",
      PENDIENTE_PAGO: "border-secondary",
    };

    boxes.forEach((box) => {
      const estado = (box.dataset.estado || "").trim().toUpperCase();

      // quita bordes anteriores por si recargas o re-renderizas
      box.classList.remove(
        "border-success",
        "border-warning",
        "border-danger",
        "border-primary",
        "border-secondary"
      );
      box.classList.add("border-3"); // grosor opcional

      const borderClass = borderByEstado[estado] || "border-secondary";
      box.classList.add(borderClass);
    });

    // --- Lógica del botón de limpieza del input ---
    const inputField = document.getElementById("id_search_name");
    const clearIcon = document.querySelector(
      '.clear-icon[data-target="id_search_name"]'
    );

    if (inputField && clearIcon) {
      const toggleClearIcon = () => {
        clearIcon.style.display =
          inputField.value.length > 0 ? "block" : "none";
      };

      toggleClearIcon();
      inputField.addEventListener("input", toggleClearIcon);

      clearIcon.addEventListener("click", () => {
        inputField.value = "";
        toggleClearIcon();
        inputField.focus();
        // Si quieres auto-buscar al limpiar:
        // inputField.closest('form').submit();
      });
    }

    // --- Modal eliminar mesa ---
    const eliminarMesaModal = document.getElementById("eliminarMesaModal");
    if (eliminarMesaModal) {
      eliminarMesaModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        if (!button) return;

        const mesasId = button.getAttribute("data-id");
        const mesasNombre = button.getAttribute("data-nombre");

        const nombreEl = document.getElementById("nombre_mesa_eliminar");
        const form = document.getElementById("eliminarMesaForm");

        if (nombreEl) nombreEl.textContent = mesasNombre || "";
        if (form && mesasId) {
          form.action = "{% url 'eliminar-menu' 0 %}".replace(
            "/0/",
            "/" + mesasId + "/"
          );
        }
      });
    }
  });
</script>
{% endblock extra_js %}
{% endblock content %} 
